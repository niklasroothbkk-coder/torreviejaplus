<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TorreviejaPlus Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f0f1;
            min-height: 100vh;
            display: flex;
        }
        
        /* WordPress-style Sidebar */
        .sidebar {
            width: 260px;
            background: #23282d;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            background: #191e23;
            border-bottom: 1px solid #32373c;
        }
        
        .sidebar-header h1 {
            color: white;
            font-size: 20px;
            margin: 0;
        }
        
        .sidebar-menu {
            padding: 10px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            color: #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            text-decoration: none;
        }
        
        .menu-item:hover {
            background: #32373c;
            color: #00b9eb;
        }
        
        .menu-item.active {
            background: #0073aa;
            border-left-color: #00b9eb;
            color: white;
        }
        
        .menu-item span {
            font-size: 20px;
        }
        
        /* Main Content Area */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 20px 40px;
        }
        
        .page-header {
            margin-bottom: 30px;
            border-bottom: 1px solid #ccd0d4;
            padding-bottom: 15px;
        }
        
        .page-header h1 {
            color: #23282d;
            font-size: 23px;
            font-weight: 400;
            margin: 0;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #23282d; text-align: left; margin-bottom: 20px; font-size: 23px; font-weight: 400; }
        .panel {
            background: white;
            border-radius: 0;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.04);
            border: 1px solid #c3c4c7;
        }
        h2 {
            color: #23282d;
            margin-bottom: 20px;
            border-bottom: 1px solid #c3c4c7;
            padding-bottom: 10px;
            font-size: 20px;
            font-weight: 400;
        }
        .form-group { margin-bottom: 20px; }
        .form-group.hidden { display: none; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 600; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button {
            background: #2271b1;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            box-shadow: 0 1px 0 #2271b1;
        }
        button:hover { background: #135e96; box-shadow: 0 1px 0 #135e96; }
        button.delete { background: #b32d2e; box-shadow: 0 1px 0 #b32d2e; }
        button.delete:hover { background: #8a2424; box-shadow: 0 1px 0 #8a2424; }
        button.edit { background: #2271b1; padding: 6px 12px; font-size: 13px; box-shadow: 0 1px 0 #2271b1; }
        button.edit:hover { background: #135e96; box-shadow: 0 1px 0 #135e96; }
        button.reactivate { background: #00a32a; padding: 6px 12px; font-size: 13px; box-shadow: 0 1px 0 #00a32a; }
        button.reactivate:hover { background: #008a20; box-shadow: 0 1px 0 #008a20; }
        .venue-item {
            background: #f6f7f7;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 0;
            border-left: 4px solid #2271b1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #c3c4c7;
            position: relative;
        }
        .status-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .status-active {
            background: #00a32a;
        }
        .status-inactive {
            background: #d63638;
        }
        .venue-info h3 { color: #333; margin-bottom: 5px; text-align: left; }
        .venue-info p { color: #666; margin: 3px 0; font-size: 14px; text-align: left; } 
        .venue-actions { display: flex; gap: 10px; }
        .success {
            background: #00a32a;
            color: white;
            padding: 12px 15px;
            border-radius: 0;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #008a20;
        }
        .error {
            background: #d63638;
            color: white;
            padding: 12px 15px;
            border-radius: 0;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #b02a2c;
        }
        .loading { text-align: center; padding: 20px; color: #666; }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .checkbox-label:hover {
            background: #f8f9fa;
        }
        .checkbox-label input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        .image-upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .image-upload-section input[type="file"] { display: none; }
        .upload-btn {
            background: #2271b1;
            color: white;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            display: inline-block;
            margin: 10px 0;
            font-size: 14px;
            box-shadow: 0 1px 0 #2271b1;
        }
        .upload-btn:hover { background: #135e96; box-shadow: 0 1px 0 #135e96; }
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid transparent;
        }
        .image-preview-item.main-image { border-color: #00a32a; }
        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #b32d2e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        .image-preview-item .main-badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: #00a32a;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        .upload-info {
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }
        .hours-row {
            display: grid;
            grid-template-columns: 90px 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        .hours-row label {
            margin: 0;
            font-weight: 600;
        }
        
        /* Content Pages */
        .content-page {
            display: none;
        }
        
        .content-page.active {
            display: block;
        }
        
        /* Venue Filters */
        .venue-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #c3c4c7;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #2271b1;
        }
        
        .category-filter select {
            padding: 10px 15px;
            border: 1px solid #c3c4c7;
            border-radius: 3px;
            font-size: 14px;
            min-width: 200px;
            background: white;
        }
        
        .category-filter select:focus {
            outline: none;
            border-color: #2271b1;
        }
        
        .filter-results {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* Credentials Section Styling */
        .credentials-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .credentials-section h2 {
            color: #856404;
            border-color: #ffc107;
            margin-bottom: 15px;
        }
        .credentials-note {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .credentials-note p {
            margin: 0;
            color: #155724;
            font-size: 13px;
        }

        /* EDIT MODAL STYLES */
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .edit-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #c3c4c7;
        }
        
        .modal-header h2 {
            margin: 0;
            padding: 0;
            border: none;
            font-size: 22px;
            color: #23282d;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
        }
    </style>
</head>
<body>
    <!-- WordPress-style Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header" onclick="switchPage('dashboard')" style="cursor: pointer;">
            <h1>üèñÔ∏è TorreviejaPlus</h1>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="switchPage('dashboard')">
                <span>üè†</span>
                <div>Dashboard</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('all-venues')">
                <span>üìã</span>
                <div>All Venues</div>
            </div>
            <div class="menu-item" onclick="switchPage('add-venue')">
                <span style="color: white;">‚ûï</span>
                <div>Add Venue</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('all-deals')">
                <span>üéØ</span>
                <div>All Deals</div>
            </div>
            <div class="menu-item" onclick="switchPage('add-deal')">
                <span style="color: white;">‚ûï</span>
                <div>New Deal</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('all-events')">
                <span>üéâ</span>
                <div>All Events</div>
            </div>
            <div class="menu-item" onclick="switchPage('add-event')">
                <span style="color: white;">‚ûï</span>
                <div>New Event</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('visitors')">
                <span>üë•</span>
                <div>Visitors</div>
            </div>
            <div class="menu-item" onclick="switchPage('customers')">
                <span>üè™</span>
                <div>Customers (Venues)</div>
            </div>
        </div>
    </div>

    <!-- EDIT VISITOR MODAL -->
    <div id="editVisitorModal" class="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Visitor</h2>
            </div>
            <div class="form-group">
                <label for="modal_visitor_name">Name</label>
                <input type="text" id="modal_visitor_name" placeholder="Enter name...">
            </div>
            <div class="modal-buttons">
                <button onclick="closeVisitorModal()" style="background: #95a5a6;">Cancel</button>
                <button onclick="saveVisitor()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- EDIT CUSTOMER MODAL -->
    <div id="editCustomerModal" class="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Customer</h2>
            </div>
            <div class="form-group">
                <label for="modal_customer_credits">Credits</label>
                <input type="number" id="modal_customer_credits" placeholder="Enter credits amount...">
            </div>
            <div class="modal-buttons">
                <button onclick="closeCustomerModal()" style="background: #95a5a6;">Cancel</button>
                <button onclick="saveCustomer()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="container">
            <div id="successMessage" class="success"></div>
            <div id="errorMessage" class="error"></div>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="content-page active">
                <div class="page-header">
                    <h1>Welcome to TorreviejaPlus Admin</h1>
                </div>
                <div class="panel" style="text-align: center; padding: 100px 30px;">
                    <img src="assets/backgrounds/TV+STOR.png" alt="TorreviejaPlus Logo" style="max-width: 600px; width: 100%; height: auto;">
                </div>
            </div>

            <!-- (rest of the HTML pages remain EXACTLY the same...) -->
            <!-- I'll continue from line ~800 where the JavaScript starts -->

            <!-- Add Venue Page -->
            <div id="add-venue-page" class="content-page">
                <div class="page-header">
                    <h1 id="formTitle">Add New Venue</h1>
                </div>
                <div class="panel">
                    <form id="venueForm">
                <input type="hidden" id="venueId">
                
                <!-- VENUE LOGIN CREDENTIALS (Only for new venues) -->
                <div id="venueCredentialsSection" class="credentials-section">
                    <h2>üîê Venue Login Credentials</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="venue_email">Email (for login) *</label>
                            <input type="email" id="venue_email" placeholder="venue@example.com">
                        </div>
                        <div class="form-group">
                            <label for="venue_password">Password (for login) *</label>
                            <input type="password" id="venue_password" placeholder="Minimum 6 characters">
                        </div>
                    </div>
                    <div class="credentials-note">
                        <p><strong>‚ö†Ô∏è IMPORTANT:</strong> These credentials will allow the venue to log into the mobile app and manage their deals/events. <strong>Required for new venues only.</strong> Leave blank when editing existing venues.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="name">Venue Name *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" required onchange="updateSubCategories()">
                        <option value="">Select category...</option>
                        <option value="Restaurants">Restaurants</option>
                        <option value="Sport Bars">Sport Bars</option>
                        <option value="Massage & Spa">Massage & Spa</option>
                        <option value="Healthcare & Emergency">Healthcare & Emergency</option>
                        <option value="Nightclubs">Nightclubs</option>
                        <option value="Post Offices & Banks">Post Offices & Banks</option>
                        <option value="Car & Bike Rentals">Car & Bike Rentals</option>
                        <option value="Shopping Centres">Shopping Centres</option>
                        <option value="Beaches">Beaches</option>
                    </select>
                </div>

                <!-- CUISINE CHECKBOXES -->
                <div class="form-group hidden" id="cuisineGroup">
                    <label>Cuisine (Select all that apply)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Thai">
                            <span>Thai</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Burger">
                            <span>Burger</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Chinese">
                            <span>Chinese</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="French">
                            <span>French</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Indian">
                            <span>Indian</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="International">
                            <span>International</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Mediterranean">
                            <span>Mediterranean</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Mexican">
                            <span>Mexican</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Pizza & Pasta">
                            <span>Pizza & Pasta</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Spanish">
                            <span>Spanish</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Steak">
                            <span>Steak</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Swedish">
                            <span>Swedish</span>
                        </label>
                    </div>
                </div>

                <!-- PUB TYPE CHECKBOXES -->
                <div class="form-group hidden" id="pubTypeGroup">
                    <label>Pub Type (Select all that apply)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="English Pub">
                            <span>English Pub</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Irish Pub">
                            <span>Irish Pub</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Sportbar">
                            <span>Sportbar</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Live Band">
                            <span>Live Band</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Serve Food">
                            <span>Serve Food</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Sport on TV">
                            <span>Sport on TV</span>
                        </label>
                    </div>
                </div>

                <!-- SPA TYPE CHECKBOXES -->
                <div class="form-group hidden" id="spaTypeGroup">
                    <label>Spa Type (Select all that apply)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" name="spa_types" value="Massage">
                            <span>Massage</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="spa_types" value="Spa">
                            <span>Spa</span>
                        </label>
                    </div>
                </div>

                <!-- SPORT TYPE SELECT -->
                <div class="form-group hidden" id="sportTypeGroup">
                    <label for="sport_type">Sport Type</label>
                    <select id="sport_type">
                        <option value="">Select sport type...</option>
                        <option value="Golf">Golf</option>
                        <option value="Padel">Padel</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Watersports">Watersports</option>
                    </select>
                </div>

                <!-- ATTRACTION TYPE SELECT -->
                <div class="form-group hidden" id="attractionTypeGroup">
                    <label for="attraction_type">Attraction Type</label>
                    <select id="attraction_type">
                        <option value="">Select attraction type...</option>
                        <option value="Beaches">Beaches</option>
                        <option value="Culture">Culture</option>
                        <option value="Markets">Markets</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Tours">Tours</option>
                    </select>
                </div>

                <!-- HEALTHCARE TYPE SELECT -->
                <div class="form-group hidden" id="healthcareTypeGroup">
                    <label for="healthcare_type">Healthcare Type</label>
                    <select id="healthcare_type">
                        <option value="">Select healthcare type...</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Clinic">Clinic</option>
                        <option value="Pharmacy">Pharmacy</option>
                        <option value="Dentist">Dentist</option>
                        <option value="Emergency Services">Emergency Services</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="location">Full Address *</label>
                        <input type="text" id="location" required placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="location_short">Short Location *</label>
                        <input type="text" id="location_short" required placeholder="Type here...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="text" id="phone" placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="whatsapp">WhatsApp</label>
                        <input type="text" id="whatsapp" placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="line">Line</label>
                        <input type="text" id="line" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-group">
                    <label for="website">Website</label>
                    <input type="url" id="website" placeholder="Type here...">
                </div>

                <div class="form-group">
    <label>üì± Social Media</label>
    <div class="form-row">
        <input type="url" id="facebook" placeholder="Facebook URL...">
        <input type="url" id="instagram" placeholder="Instagram URL...">
    </div>
    <div class="form-row" style="margin-top: 10px;">
        <input type="url" id="tiktok" placeholder="TikTok URL...">
        <input type="url" id="xtwitter" placeholder="X/Twitter URL...">
    </div>
</div>

                <div class="form-group">
                    <label>‚è∞ Opening Hours</label>
                    <div class="hours-row">
                        <label>Monday:</label>
                        <input type="text" id="monday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Tuesday:</label>
                        <input type="text" id="tuesday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Wednesday:</label>
                        <input type="text" id="wednesday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Thursday:</label>
                        <input type="text" id="thursday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Friday:</label>
                        <input type="text" id="friday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Saturday:</label>
                        <input type="text" id="saturday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Sunday:</label>
                        <input type="text" id="sunday_hours" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-group">
                    <label>‚ú® Features</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_indoor">
                            <span>üè† Indoor Seating</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_outdoor">
                            <span>‚òÄÔ∏è Outdoor Seating</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_creditcard">
                            <span>üí≥ Accept Credit Cards</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_seaview">
                            <span>üåä Sea View</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_smoking">
                            <span>üö¨ Smoking Area</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_wheelchair">
                            <span>‚ôø Wheelchair Accessible</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üì∏ Images (Max 6) - First image will be the main card image</label>
                    <div class="image-upload-section">
                        <input type="file" id="imageInput" accept="image/*" multiple>
                        <label for="imageInput" class="upload-btn">Choose Images</label>
                        <div class="upload-info">
                            Max 6 images ‚Ä¢ JPG, PNG, WebP ‚Ä¢ First image = Card image
                        </div>
                        <div id="imagePreview" class="image-preview-grid"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="rating">Rating (0-5)</label>
                        <input type="number" id="rating" step="0.1" min="0" max="5" placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="review_count">Review Count</label>
                        <input type="number" id="review_count" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="price_range">Price Range *</label>
                        <select id="price_range" required>
                            <option value="">Select price...</option>
                            <option value="‚Ç¨">‚Ç¨ (Budget)</option>
                            <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ (Moderate)</option>
                            <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ (Upscale)</option>
                            <option value="‚Ç¨‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Luxury)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="views">Views</label>
                        <input type="number" id="views" placeholder="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="registered_date">Registered Date</label>
                    <input type="date" id="registered_date">
                </div>

                <button type="submit" id="submitBtn">Add Venue</button>
                <button type="button" id="cancelBtn" onclick="cancelEdit()" style="display: none; background: #95a5a6;">Cancel</button>
            </form>
                </div>
            </div>

<!-- Add Deal Page -->
            <div id="add-deal-page" class="content-page">
                <div class="page-header">
                    <h1 id="dealFormTitle">Add New Deal</h1>
                </div>
                <div class="panel">
                <form id="dealForm">
                    <input type="hidden" id="dealId">
                    
                    <div class="form-group">
                        <label for="deal_name">Deal Name *</label>
                        <input type="text" id="deal_name" required>
                    </div>

                    <div class="form-group">
                        <label for="deal_category">Deal / Promotion Category *</label>
                        <select id="deal_category" required>
                            <option value="">Select category...</option>
                            <option value="Happy Hours">Happy Hours</option>
                            <option value="Watersport Deals">Watersport Deals</option>
                            <option value="Restaurant Deals">Restaurant Deals</option>
                            <option value="Sport Deals">Sport Deals</option>
                            <option value="Pub & Bar Deals">Pub & Bar Deals</option>
                            <option value="Other Deals">Other Deals</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="deal_description">Description *</label>
                        <textarea id="deal_description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="deal_phone">Phone</label>
                        <input type="text" id="deal_phone" placeholder="Type here...">
                    </div>

                    <div class="form-group">
                        <label for="deal_venue_link">Link to Venue (for contact/hours/rating) *</label>
                        <select id="deal_venue_link" required>
                            <option value="">Select venue...</option>
                            <!-- Will be populated with venues from database -->
                        </select>
                    </div>

                    <!-- Date & Time Section -->
                    <div class="form-group">
                        <label>üìÖ Deal Schedule Start Day</label>
                        
                        <div class="form-row" style="margin-top: 10px; grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label for="deal_date">Date *</label>
                                <input type="date" id="deal_date" required>
                            </div>
                            <div class="form-group">
                                <label for="deal_start_time">Start Time</label>
                                <input type="time" id="deal_start_time" value="12:00">
                            </div>
                            <div class="form-group">
                                <label for="deal_end_time">End Time</label>
                                <input type="time" id="deal_end_time" value="12:00">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="deal_repeat" onchange="toggleRepeatOptions()" style="width: auto; margin-right: 8px;">
                                <span>üîÅ Repeat (show for entire month or specific days)</span>
                            </label>
                        </div>

                        <!-- Repeat Options (hidden by default) -->
                        <div id="repeatOptions" class="form-group hidden" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <label style="margin-bottom: 10px;">Repeat on:</label>
                            
                            <!-- Grid layout: 4 columns -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                                <!-- Row 1 -->
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Monday">
                                    <span>Monday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Tuesday">
                                    <span>Tuesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Wednesday">
                                    <span>Wednesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Thursday">
                                    <span>Thursday</span>
                                </label>
                                
                                <!-- Row 2 -->
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Friday">
                                    <span>Friday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Saturday">
                                    <span>Saturday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Sunday">
                                    <span>Sunday</span>
                                </label>
                            </div>

                            <!-- Third row: Number of weeks -->
                            <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                                <label for="repeat_weeks">Number of weeks to repeat</label>
                                <input type="number" id="repeat_weeks" min="1" max="52" placeholder="4" style="width: 150px;">
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    üìù Example: Select Friday + Saturday with 4 weeks = 8 deals total (Friday √ó 4 + Saturday √ó 4)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üì∏ Deal Image (Max 1) - Main card image</label>
                        <div class="image-upload-section">
                            <input type="file" id="dealImageInput" accept="image/*">
                            <label for="dealImageInput" class="upload-btn">Choose Image</label>
                            <div class="upload-info">
                                Max 1 image ‚Ä¢ JPG, PNG, WebP
                            </div>
                            <div id="dealImagePreview" class="image-preview-grid"></div>
                        </div>
                    </div>

                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label for="deal_price_range">Price Range</label>
                            <select id="deal_price_range">
                                <option value="">Select price...</option>
                                <option value="‚Ç¨">‚Ç¨ (Budget)</option>
                                <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ (Moderate)</option>
                                <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ (Upscale)</option>
                                <option value="‚Ç¨‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Luxury)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deal_price">Price (e.g. ‚Ç¨15, Buy 1 Get 1, 50% off)</label>
                            <input type="text" id="deal_price" placeholder="‚Ç¨15:00">
                        </div>
                        <div class="form-group">
                            <label for="deal_views">Views</label>
                            <input type="number" id="deal_views" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="deal_registered_date">Registered Date</label>
                        <input type="date" id="deal_registered_date">
                    </div>

                    <button type="submit" id="dealSubmitBtn">Add Deal</button>
                    <button type="button" id="dealCancelBtn" onclick="cancelDealEdit()" style="display: none; background: #95a5a6;">Cancel</button>
                </form>
                </div>
            </div>

            <!-- All Venues Page -->
            <div id="all-venues-page" class="content-page">
                <div class="page-header">
                    <h1>All Venues & Services</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="venueSearch" placeholder="üîç Search by venue name..." oninput="filterVenues()">
                        </div>
                        <div class="category-filter">
                            <select id="categoryFilter" onchange="filterVenues()">
                                <option value="">All Categories</option>
                                <option value="Restaurants">Restaurants</option>
                                <option value="Sport Bars">Sport Bars</option>
                                <option value="Massage & Spa">Massage & Spa</option>
                                <option value="Healthcare & Emergency">Healthcare & Emergency</option>
                                <option value="Nightclubs">Nightclubs</option>
                                <option value="Post Offices & Banks">Post Offices & Banks</option>
                                <option value="Car & Bike Rentals">Car & Bike Rentals</option>
                                <option value="Shopping Centres">Shopping Centres</option>
                                <option value="Beaches">Beaches</option>
                            </select>
                        </div>
                        <div class="category-filter">
                            <select id="venueStatusFilter" onchange="filterVenues()">
                                <option value="all">All Venues</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="filterResults" class="filter-results" style="display: none;"></div>
                    <div id="venuesList" class="loading">Loading venues...</div>
                </div>
            </div>

            <!-- All Deals Page -->
            <div id="all-deals-page" class="content-page">
                <div class="page-header">
                    <h1>All Deals & Promotions</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="dealSearch" placeholder="üîç Search by deal name..." oninput="filterDeals()">
                        </div>
                        <div class="category-filter">
                            <select id="dealCategoryFilter" onchange="filterDeals()">
                                <option value="">All Categories</option>
                                <option value="Happy Hours">Happy Hours</option>
                                <option value="Watersport Deals">Watersport Deals</option>
                                <option value="Restaurant Deals">Restaurant Deals</option>
                                <option value="Sport Deals">Sport Deals</option>
                                <option value="Pub & Bar Deals">Pub & Bar Deals</option>
                                <option value="Other Deals">Other Deals</option>
                            </select>
                        </div>
                        <div class="category-filter">
                            <select id="dealStatusFilter" onchange="filterDeals()">
                                <option value="all">All Deals</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Old/Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="dealFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="dealsList" class="loading">Loading deals...</div>
                </div>
            </div>

            <!-- Add Event Page -->
            <div id="add-event-page" class="content-page">
                <div class="page-header">
                    <h1 id="eventFormTitle">Add New Event</h1>
                </div>
                <div class="panel">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    
                    <div class="form-group">
                        <label for="event_name">Event Name *</label>
                        <input type="text" id="event_name" required>
                    </div>

                    <div class="form-group">
                        <label for="event_category">Events / Happenings Category *</label>
                        <select id="event_category" required>
                            <option value="">Select category...</option>
                            <option value="Concerts & Festivals">Concerts & Festivals</option>
                            <option value="Sports Events">Sports Events</option>
                            <option value="Markets & Attractions">Markets & Attractions</option>
                            <option value="Tours & Trips">Tours & Trips</option>
                            <option value="Other Events">Other Events</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="event_description">Description *</label>
                        <textarea id="event_description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="event_phone">Phone</label>
                        <input type="text" id="event_phone" placeholder="Type here...">
                    </div>

                    <div class="form-group">
                        <label for="event_website">Website / Link</label>
                        <input type="url" id="event_website" placeholder="Type here...">
                    </div>

                    <div class="form-group">
                        <label>üìÖ Event Schedule Start Day</label>
                        
                        <div class="form-row" style="margin-top: 10px; grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label for="event_date">Date *</label>
                                <input type="date" id="event_date" required>
                            </div>
                            <div class="form-group">
                                <label for="event_start_time">Start Time</label>
                                <input type="time" id="event_start_time" value="20:00">
                            </div>
                            <div class="form-group">
                                <label for="event_end_time">End Time</label>
                                <input type="time" id="event_end_time" value="23:00">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="event_repeat" onchange="toggleEventRepeatOptions()" style="width: auto; margin-right: 8px;">
                                <span>üîÅ Repeat (show for entire month or specific days)</span>
                            </label>
                        </div>

                        <div id="eventRepeatOptions" class="form-group hidden" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <label style="margin-bottom: 10px;">Repeat on:</label>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Monday">
                                    <span>Monday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Tuesday">
                                    <span>Tuesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Wednesday">
                                    <span>Wednesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Thursday">
                                    <span>Thursday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Friday">
                                    <span>Friday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Saturday">
                                    <span>Saturday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Sunday">
                                    <span>Sunday</span>
                                </label>
                            </div>

                            <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                                <label for="event_repeat_weeks">Number of weeks to repeat</label>
                                <input type="number" id="event_repeat_weeks" min="1" max="52" placeholder="4" style="width: 150px;">
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    üìù Example: Select Friday + Saturday with 4 weeks = 8 events total
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üì∏ Event Image (Max 1) - Main card image</label>
                        <div class="image-upload-section">
                            <input type="file" id="eventImageInput" accept="image/*">
                            <label for="eventImageInput" class="upload-btn">Choose Image</label>
                            <div class="upload-info">
                                Max 1 image ‚Ä¢ JPG, PNG, WebP
                            </div>
                            <div id="eventImagePreview" class="image-preview-grid"></div>
                        </div>
                    </div>

                    <div class="form-row" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="event_price">Price (e.g. ‚Ç¨15, Free Entry)</label>
                            <input type="text" id="event_price" placeholder="Free">
                        </div>
                        <div class="form-group">
                            <label for="event_views">Views</label>
                            <input type="number" id="event_views" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="event_registered_date">Registered Date</label>
                        <input type="date" id="event_registered_date">
                    </div>

                    <button type="submit" id="eventSubmitBtn">Add Event</button>
                    <button type="button" id="eventCancelBtn" onclick="cancelEventEdit()" style="display: none; background: #95a5a6;">Cancel</button>
                </form>
                </div>
            </div>

            <!-- All Events Page -->
            <div id="all-events-page" class="content-page">
                <div class="page-header">
                    <h1>All Events</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="eventSearch" placeholder="üîç Search by event name..." oninput="filterEvents()">
                        </div>
                        <div class="category-filter">
                            <select id="eventCategoryFilter" onchange="filterEvents()">
                                <option value="">All Categories</option>
                                <option value="Concerts & Festivals">Concerts & Festivals</option>
                                <option value="Sports Events">Sports Events</option>
                                <option value="Markets & Attractions">Markets & Attractions</option>
                                <option value="Tours & Trips">Tours & Trips</option>
                                <option value="Other Events">Other Events</option>
                            </select>
                        </div>
                        <div class="category-filter">
                            <select id="eventStatusFilter" onchange="filterEvents()">
                                <option value="all">All Events</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Old/Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="eventFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="eventsList" class="loading">Loading events...</div>
                </div>
            </div>

            <!-- Visitors Page -->
            <div id="visitors-page" class="content-page">
                <div class="page-header">
                    <h1>üë• Visitors (App Users)</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="visitorSearch" placeholder="üîç Search by name or email..." oninput="filterVisitors()">
                        </div>
                    </div>
                    <div id="visitorFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="visitorsList" class="loading">Loading visitors...</div>
                </div>
            </div>

            <!-- Customers (Venues) Page -->
            <div id="customers-page" class="content-page">
                <div class="page-header">
                    <h1>üè™ Customers (Venue Users)</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="customerSearch" placeholder="üîç Search by venue name or email..." oninput="filterCustomers()">
                        </div>
                        <div class="category-filter">
                            <select id="customerStatusFilter" onchange="filterCustomers()">
                                <option value="all">All Customers</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="customerFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="customersList" class="loading">Loading customers...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Page switching for sidebar menu
        function switchPage(pageName) {
            const pages = document.querySelectorAll('.content-page');
            pages.forEach(page => page.classList.remove('active'));
            
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            
            const targetPage = document.getElementById(pageName + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            if (pageName === 'all-venues') {
                loadVenues();
            } else if (pageName === 'all-deals') {
                loadDeals();
            } else if (pageName === 'all-events') {
                loadEvents();
            } else if (pageName === 'visitors') {
                loadVisitors();
            } else if (pageName === 'customers') {
                loadCustomers();
            }
        }

        const SUPABASE_URL = 'https://vfponburmjbuqqneigjr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmcG9uYnVybWpidXFxbmVpZ2pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTUwODgsImV4cCI6MjA4MDk5MTA4OH0.4osS6AQ6tUaRpoO8dtwlBBOsbnNymzFR7SB2aWVj7DM';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let editingVenue = null;
        let uploadedImages = [];
        let editingDeal = null;
        let uploadedDealImage = null;
        let allVenues = [];
        let allDeals = [];
        let allVisitors = [];
        let allCustomers = [];
        
        // MODAL VARIABLES
        let currentEditingVisitorId = null;
        let currentEditingCustomerId = null;

        function updateSubCategories() {
            const category = document.getElementById('category').value;
            
            document.getElementById('cuisineGroup').classList.add('hidden');
            document.getElementById('pubTypeGroup').classList.add('hidden');
            document.getElementById('spaTypeGroup').classList.add('hidden');
            document.getElementById('sportTypeGroup').classList.add('hidden');
            document.getElementById('attractionTypeGroup').classList.add('hidden');
            document.getElementById('healthcareTypeGroup').classList.add('hidden');
            
            if (category === 'Restaurants') {
                document.getElementById('cuisineGroup').classList.remove('hidden');
            } else if (category === 'Sport Bars') {
                document.getElementById('pubTypeGroup').classList.remove('hidden');
            } else if (category === 'Massage & Spa') {
                document.getElementById('spaTypeGroup').classList.remove('hidden');
            } else if (category === 'Sports Activities') {
                document.getElementById('sportTypeGroup').classList.remove('hidden');
            } else if (category === 'Markets & Attractions') {
                document.getElementById('attractionTypeGroup').classList.remove('hidden');
            } else if (category === 'Healthcare & Emergency') {
                document.getElementById('healthcareTypeGroup').classList.remove('hidden');
            }
        }

        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            
            const venueRegisteredDate = document.getElementById('registered_date');
            if (venueRegisteredDate) {
                venueRegisteredDate.value = today;
            }
            
            const dealRegisteredDate = document.getElementById('deal_registered_date');
            if (dealRegisteredDate) {
                dealRegisteredDate.value = today;
            }
            
            const eventRegisteredDate = document.getElementById('event_registered_date');
            if (eventRegisteredDate) {
                eventRegisteredDate.value = today;
            }
        });

        document.addEventListener('DOMContentLoaded', () => { 
            loadVenues();
            loadVenuesForDealDropdown();
        });

document.getElementById('imageInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (uploadedImages.length + files.length > 6) {
                showError('Maximum 6 images allowed!');
                return;
            }

            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                await uploadImage(file);
            }
            renderImagePreviews();
        });

        document.getElementById('dealImageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }

            await uploadDealImage(file);
        });

        async function uploadImage(file) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = fileName;

                const { data, error } = await supabaseClient.storage
                    .from('venue-images')
                    .upload(filePath, file);

                if (error) throw error;

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('venue-images')
                    .getPublicUrl(filePath);

                uploadedImages.push(publicUrl);
                showSuccess('Image uploaded!');
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreview');
            container.innerHTML = uploadedImages.map((url, index) => `
                <div class="image-preview-item ${index === 0 ? 'main-image' : ''}">
                    <img src="${url}" alt="Preview ${index + 1}">
                    ${index === 0 ? '<div class="main-badge">MAIN</div>' : ''}
                    <button type="button" class="remove-image" onclick="removeImage(${index})">√ó</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderImagePreviews();
        }

        async function uploadDealImage(file) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `deal-${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = fileName;

                const { data, error } = await supabaseClient.storage
                    .from('venue-images')
                    .upload(filePath, file);

                if (error) throw error;

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('venue-images')
                    .getPublicUrl(filePath);

                uploadedDealImage = publicUrl;
                renderDealImagePreview();
                showSuccess('Image uploaded!');
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        function renderDealImagePreview() {
            const container = document.getElementById('dealImagePreview');
            if (!uploadedDealImage) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `
                <div class="image-preview-item main-image">
                    <img src="${uploadedDealImage}" alt="Deal image">
                    <div class="main-badge">MAIN</div>
                    <button type="button" class="remove-image" onclick="removeDealImage()">√ó</button>
                </div>
            `;
        }

        function removeDealImage() {
            uploadedDealImage = null;
            renderDealImagePreview();
            document.getElementById('dealImageInput').value = '';
        }

        document.getElementById('venueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const openingHours = {
                monday: document.getElementById('monday_hours').value,
                tuesday: document.getElementById('tuesday_hours').value,
                wednesday: document.getElementById('wednesday_hours').value,
                thursday: document.getElementById('thursday_hours').value,
                friday: document.getElementById('friday_hours').value,
                saturday: document.getElementById('saturday_hours').value,
                sunday: document.getElementById('sunday_hours').value
            };
            
            const features = [];
            if (document.getElementById('feature_indoor').checked) features.push('Indoor Seating');
            if (document.getElementById('feature_outdoor').checked) features.push('Outdoor Seating');
            if (document.getElementById('feature_creditcard').checked) features.push('Accept Credit Cards');
            if (document.getElementById('feature_seaview').checked) features.push('Sea View');
            if (document.getElementById('feature_smoking').checked) features.push('Smoking Area');
            if (document.getElementById('feature_wheelchair').checked) features.push('Wheelchair Accessible');
            
            const cuisineCheckboxes = document.querySelectorAll('input[name="cuisine"]:checked');
            const selectedCuisines = Array.from(cuisineCheckboxes).map(cb => cb.value);
            
            const pubTypeCheckboxes = document.querySelectorAll('input[name="pub_types"]:checked');
            const selectedPubTypes = Array.from(pubTypeCheckboxes).map(cb => cb.value);
            
            const spaTypeCheckboxes = document.querySelectorAll('input[name="spa_types"]:checked');
            const selectedSpaTypes = Array.from(spaTypeCheckboxes).map(cb => cb.value);
            
            const venueData = {
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                cuisine: selectedCuisines.length > 0 && document.getElementById('category').value === 'Restaurants' ? selectedCuisines : null,
                pub_types: selectedPubTypes.length > 0 && document.getElementById('category').value === 'Sport Bars' ? selectedPubTypes : null,
                spa_types: selectedSpaTypes.length > 0 && document.getElementById('category').value === 'Massage & Spa' ? selectedSpaTypes : null,
                sport_types: document.getElementById('sport_type').value && document.getElementById('category').value === 'Sports Activities' ? [document.getElementById('sport_type').value] : null,
                attraction_types: document.getElementById('attraction_type').value && document.getElementById('category').value === 'Markets & Attractions' ? [document.getElementById('attraction_type').value] : null,
                healthcare_type: document.getElementById('healthcare_type').value && document.getElementById('category').value === 'Healthcare & Emergency' ? document.getElementById('healthcare_type').value : null,
                description: document.getElementById('description').value,
                location: document.getElementById('location').value,
                location_short: document.getElementById('location_short').value,
                rating: parseFloat(document.getElementById('rating').value) || 0,
                review_count: parseInt(document.getElementById('review_count').value) || 0,
                price_range: document.getElementById('price_range').value,
                views: parseInt(document.getElementById('views').value) || 0,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                whatsapp: document.getElementById('whatsapp').value,
                line: document.getElementById('line').value,
                website: document.getElementById('website').value,
                facebook: document.getElementById('facebook').value,
                instagram: document.getElementById('instagram').value,
                tiktok: document.getElementById('tiktok').value,
                'x/twitter': document.getElementById('xtwitter').value,
                opening_hours: openingHours,
                features: features,
                registered_date: document.getElementById('registered_date').value || null,
                images: uploadedImages,
                active: true
            };

            try {
                let venueId = editingVenue;
                
                if (editingVenue) {
                    // EDITING EXISTING VENUE
                    // First, update the venue data
                    const { error: updateError } = await supabaseClient.from('venues').update(venueData).eq('id', editingVenue);
                    if (updateError) throw updateError;
                    
                    // Check if venue has owner_user_id (auth user)
                    const { data: venueCheck } = await supabaseClient.from('venues').select('owner_user_id').eq('id', editingVenue).single();
                    
                    // If no owner_user_id AND email/password provided, create auth user
                    if (!venueCheck.owner_user_id) {
                        const venueEmail = document.getElementById('venue_email').value;
                        const venuePassword = document.getElementById('venue_password').value;
                        
                        if (venueEmail && venuePassword) {
                            if (venuePassword.length < 6) {
                                showError('Password must be at least 6 characters!');
                                return;
                            }
                            
                            try {
                                const response = await fetch('https://vfponburmjbuqqneigjr.supabase.co/functions/v1/create-venue-user', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                    },
                                    body: JSON.stringify({
                                        email: venueEmail,
                                        password: venuePassword,
                                        venueId: editingVenue
                                    })
                                });
                                
                                const result = await response.json();
                                
                                if (!response.ok || result.error) {
                                    throw new Error(result.error || 'Failed to create venue user');
                                }
                                
                                showSuccess(`‚úÖ Venue updated and login created! Email: ${venueEmail}`);
                            } catch (edgeFunctionError) {
                                showError(`Venue updated but login creation failed: ${edgeFunctionError.message}`);
                                return;
                            }
                        } else {
                            showSuccess('Venue updated!');
                        }
                    } else {
                        showSuccess('Venue updated!');
                    }
                } else {
                    // CREATING NEW VENUE
                    const venueEmail = document.getElementById('venue_email').value;
                    const venuePassword = document.getElementById('venue_password').value;
                    
                    if (!venueEmail || !venuePassword) {
                        showError('Email and Password are required for new venues!');
                        return;
                    }
                    
                    if (venuePassword.length < 6) {
                        showError('Password must be at least 6 characters!');
                        return;
                    }
                    
                    const { data: newVenue, error: venueError } = await supabaseClient
                        .from('venues')
                        .insert([venueData])
                        .select()
                        .single();
                    
                    if (venueError) throw venueError;
                    venueId = newVenue.id;
                    
                    // Step 2: Call Edge Function to create auth user + link profile
                    try {
                        const response = await fetch('https://vfponburmjbuqqneigjr.supabase.co/functions/v1/create-venue-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                email: venueEmail,
                                password: venuePassword,
                                venueId: venueId
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok || result.error) {
                            throw new Error(result.error || 'Failed to create venue user');
                        }
                        
                        showSuccess(`‚úÖ Venue created successfully! The venue can now log in with email: ${venueEmail}`);
                    } catch (edgeFunctionError) {
                        // Edge function failed - rollback venue creation
                        await supabaseClient.from('venues').delete().eq('id', venueId);
                        throw new Error(`Failed to create venue user: ${edgeFunctionError.message}`);
                    }
                }
                
                document.getElementById('venueForm').reset();
                document.getElementById('venue_email').value = '';
                document.getElementById('venue_password').value = '';
                uploadedImages = [];
                renderImagePreviews();
                cancelEdit();
                loadVenues();
                
                switchPage('all-venues');
            } catch (error) {
                showError('Error: ' + error.message);
            }
        });

        async function loadVenues() {
            const listDiv = document.getElementById('venuesList');
            listDiv.innerHTML = '<div class="loading">Loading...</div>';
            try {
                const { data, error } = await supabaseClient.from('venues').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                
                allVenues = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No venues yet!</p>';
                    return;
                }
                
                renderVenues(data);
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function renderVenues(venues) {
            const listDiv = document.getElementById('venuesList');
            
            if (venues.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No venues match your search.</p>';
                return;
            }
            
            listDiv.innerHTML = venues.map(v => `
                    <div class="venue-item">
                        <div class="status-indicator ${v.active !== false ? 'status-active' : 'status-inactive'}" title="${v.active !== false ? 'Active' : 'Inactive'}"></div>
                        <div class="venue-info">
                            <h3>${v.name}</h3>
                            <p><strong>Category:</strong> ${v.category || 'N/A'}</p>
                            ${v.cuisine && v.cuisine.length > 0 ? `<p><strong>Cuisine:</strong> ${Array.isArray(v.cuisine) ? v.cuisine.join(', ') : v.cuisine}</p>` : ''}
                            ${v.pub_types && v.pub_types.length > 0 ? `<p><strong>Pub Types:</strong> ${Array.isArray(v.pub_types) ? v.pub_types.join(', ') : v.pub_types}</p>` : ''}
                            ${v.spa_types && v.spa_types.length > 0 ? `<p><strong>Spa Types:</strong> ${Array.isArray(v.spa_types) ? v.spa_types.join(', ') : v.spa_types}</p>` : ''}
                            ${v.sport_types && v.sport_types.length > 0 ? `<p><strong>Sport Types:</strong> ${Array.isArray(v.sport_types) ? v.sport_types.join(', ') : v.sport_types}</p>` : ''}
                            ${v.attraction_types && v.attraction_types.length > 0 ? `<p><strong>Attraction Types:</strong> ${Array.isArray(v.attraction_types) ? v.attraction_types.join(', ') : v.attraction_types}</p>` : ''}
                            ${v.healthcare_type ? `<p><strong>Healthcare Type:</strong> ${v.healthcare_type}</p>` : ''}
                            <p><strong>Location:</strong> ${v.location_short || v.location}</p>
                            <p><strong>Price:</strong> ${v.price_range} | <strong>Rating:</strong> ${v.rating || 0} ‚≠ê</p>
                            ${v.images && v.images.length > 0 ? `<p><strong>Images:</strong> ${v.images.length} üì∏</p>` : ''}
                        </div>
                        <div class="venue-actions">
                            ${v.active !== false ? 
                                `<button class="reactivate" onclick="pauseVenue(${v.id}, '${v.name.replace(/'/g, "\\'")}')">‚è∏Ô∏è Pause</button>` : 
                                `<button class="reactivate" onclick="unpauseVenue(${v.id}, '${v.name.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è Unpause</button>`
                            }
                            <button class="edit" onclick="editVenue(${v.id})">Edit</button>
                            <button class="delete" onclick="deleteVenue(${v.id}, '${v.name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function filterVenues() {
            const searchTerm = document.getElementById('venueSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('venueStatusFilter').value;
            
            let filtered = allVenues;
            
            if (searchTerm) {
                filtered = filtered.filter(v => v.name.toLowerCase().includes(searchTerm));
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(v => v.category === categoryFilter);
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(v => v.active !== false);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(v => v.active === false);
            }
            
            const resultsDiv = document.getElementById('filterResults');
            if (searchTerm || categoryFilter || statusFilter !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allVenues.length} venues`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderVenues(filtered);
        }

        async function editVenue(id) {
            try {
                const { data, error } = await supabaseClient.from('venues').select('*').eq('id', id).single();
                if (error) throw error;
                
                editingVenue = id;
                document.getElementById('formTitle').textContent = 'Edit Venue';
                document.getElementById('submitBtn').textContent = 'Update Venue';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                
                document.getElementById('venueCredentialsSection').style.display = 'block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-venue-page').classList.add('active');
                
                document.getElementById('name').value = data.name || '';
                document.getElementById('category').value = data.category || '';
                updateSubCategories();
                
                let cuisineArray = [];
                if (data.cuisine) {
                    if (Array.isArray(data.cuisine)) {
                        cuisineArray = data.cuisine;
                    } else if (typeof data.cuisine === 'string') {
                        try {
                            cuisineArray = JSON.parse(data.cuisine);
                        } catch (e) {
                            cuisineArray = [data.cuisine];
                        }
                    }
                }
                document.querySelectorAll('input[name="cuisine"]').forEach(checkbox => {
                    checkbox.checked = cuisineArray.includes(checkbox.value);
                });
                
                let pubTypesArray = [];
                if (data.pub_types) {
                    if (Array.isArray(data.pub_types)) {
                        pubTypesArray = data.pub_types;
                    } else if (typeof data.pub_types === 'string') {
                        try {
                            pubTypesArray = JSON.parse(data.pub_types);
                        } catch (e) {
                            pubTypesArray = [data.pub_types];
                        }
                    }
                }
                document.querySelectorAll('input[name="pub_types"]').forEach(checkbox => {
                    checkbox.checked = pubTypesArray.includes(checkbox.value);
                });
                
                let spaTypesArray = [];
                if (data.spa_types) {
                    if (Array.isArray(data.spa_types)) {
                        spaTypesArray = data.spa_types;
                    } else if (typeof data.spa_types === 'string') {
                        try {
                            spaTypesArray = JSON.parse(data.spa_types);
                        } catch (e) {
                            spaTypesArray = [data.spa_types];
                        }
                    }
                }
                document.querySelectorAll('input[name="spa_types"]').forEach(checkbox => {
                    checkbox.checked = spaTypesArray.includes(checkbox.value);
                });
                
                document.getElementById('sport_type').value = (data.sport_types && data.sport_types[0]) || '';
                document.getElementById('attraction_type').value = (data.attraction_types && data.attraction_types[0]) || '';
                document.getElementById('healthcare_type').value = data.healthcare_type || '';
                
                document.getElementById('description').value = data.description || '';
                document.getElementById('location').value = data.location || '';
                document.getElementById('location_short').value = data.location_short || '';
                document.getElementById('rating').value = data.rating || '';
                document.getElementById('review_count').value = data.review_count || '';
                document.getElementById('price_range').value = data.price_range || '';
                document.getElementById('views').value = data.views || '';
                document.getElementById('phone').value = data.phone || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('whatsapp').value = data.whatsapp || '';
                document.getElementById('line').value = data.line || '';
                document.getElementById('website').value = data.website || '';
                document.getElementById('facebook').value = data.facebook || '';
                document.getElementById('instagram').value = data.instagram || '';
                document.getElementById('tiktok').value = data.tiktok || '';
                document.getElementById('xtwitter').value = data['x/twitter'] || '';
                
                if (data.opening_hours) {
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    days.forEach(day => {
                        if (data.opening_hours[day]) {
                            document.getElementById(`${day}_hours`).value = data.opening_hours[day] || '';
                        }
                    });
                }
                
                document.getElementById('registered_date').value = data.registered_date || '';
                
                document.getElementById('feature_indoor').checked = data.features && data.features.includes('Indoor Seating');
                document.getElementById('feature_outdoor').checked = data.features && data.features.includes('Outdoor Seating');
                document.getElementById('feature_creditcard').checked = data.features && data.features.includes('Accept Credit Cards');
                document.getElementById('feature_seaview').checked = data.features && data.features.includes('Sea View');
                document.getElementById('feature_smoking').checked = data.features && data.features.includes('Smoking Area');
                document.getElementById('feature_wheelchair').checked = data.features && data.features.includes('Wheelchair Accessible');
                
                uploadedImages = data.images || [];
                renderImagePreviews();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function cancelEdit() {
            editingVenue = null;
            document.getElementById('formTitle').textContent = 'Add New Venue';
            document.getElementById('submitBtn').textContent = 'Add Venue';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('venueForm').reset();
            
            document.getElementById('venueCredentialsSection').style.display = 'block';
            document.getElementById('venue_email').value = '';
            document.getElementById('venue_password').value = '';
            
            document.querySelectorAll('input[name="cuisine"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="pub_types"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="spa_types"]').forEach(cb => cb.checked = false);
            
            uploadedImages = [];
            renderImagePreviews();
            updateSubCategories();
        }

        async function deleteVenue(id, name) {
    if (!confirm(`Delete "${name}"?`)) return;
    try {
        // First delete from profiles if exists
        await supabaseClient.from('profiles').delete().eq('venue_id', id);
        
        // Then delete venue
        const { error } = await supabaseClient.from('venues').delete().eq('id', id);
        if (error) throw error;
        showSuccess('Deleted!');
        loadVenues();
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

        async function pauseVenue(id, name) {
            if (!confirm(`Pause "${name}"? It will be hidden from the app.`)) return;
            try {
                const { error } = await supabaseClient.from('venues').update({ active: false }).eq('id', id);
                if (error) throw error;
                showSuccess('Venue paused!');
                loadVenues();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function unpauseVenue(id, name) {
            if (!confirm(`Unpause "${name}"? It will be visible in the app again.`)) return;
            try {
                const { error } = await supabaseClient.from('venues').update({ active: true }).eq('id', id);
                if (error) throw error;
                showSuccess('Venue unpaused!');
                loadVenues();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function showSuccess(msg) {
            const div = document.getElementById('successMessage');
            div.textContent = msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 8000);
        }

        function showError(msg) {
            const div = document.getElementById('errorMessage');
            div.textContent = msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 8000);
        }

        function toggleRepeatOptions() {
            const checkbox = document.getElementById('deal_repeat');
            const repeatOptions = document.getElementById('repeatOptions');
            
            if (checkbox.checked) {
                repeatOptions.classList.remove('hidden');
            } else {
                repeatOptions.classList.add('hidden');
            }
        }

        function cancelDealEdit() {
            document.getElementById('dealForm').reset();
            document.getElementById('dealFormTitle').textContent = 'Add New Deal';
            document.getElementById('dealSubmitBtn').textContent = 'Add Deal';
            document.getElementById('dealCancelBtn').style.display = 'none';
            uploadedDealImage = null;
            renderDealImagePreview();
        }

document.getElementById('dealForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dealName = document.getElementById('deal_name').value;
            const dealCategory = document.getElementById('deal_category').value;
            const dealDescription = document.getElementById('deal_description').value;
            const dealPhone = document.getElementById('deal_phone').value;
            const venueId = document.getElementById('deal_venue_link').value;
            const dealDate = document.getElementById('deal_date').value;
            const startTime = document.getElementById('deal_start_time').value;
            const endTime = document.getElementById('deal_end_time').value;
            const isRepeat = document.getElementById('deal_repeat').checked;
            const dealPrice = document.getElementById('deal_price').value;
            const dealViews = parseInt(document.getElementById('deal_views').value) || 0;
            const registeredDate = document.getElementById('deal_registered_date').value || null;

            try {
                const repeatDaysCheckboxes = document.querySelectorAll('input[name="repeat_days"]:checked');
                const repeatDays = Array.from(repeatDaysCheckboxes).map(cb => cb.value);
                const repeatWeeks = parseInt(document.getElementById('repeat_weeks').value) || 0;

                const dealData = {
                    name: dealName,
                    category: dealCategory,
                    description: dealDescription,
                    phone: dealPhone,
                    venue_id: parseInt(venueId),
                    deal_date: dealDate,
                    start_time: startTime || null,
                    end_time: endTime || null,
                    is_recurring: isRepeat,
                    recurring_day: (isRepeat && repeatDays.length > 0) ? repeatDays.join(',') : null,
                    recurring_weeks: (isRepeat && repeatWeeks > 0) ? repeatWeeks : null,
                    price: dealPrice,
                    price_range: document.getElementById('deal_price_range').value || null,
                    image_url: uploadedDealImage,
                    views: dealViews,
                    registered_date: registeredDate,
                    active: true
                };

                if (editingDeal) {
                    const { error } = await supabaseClient.from('deals').update(dealData).eq('id', editingDeal);
                    if (error) throw error;
                    showSuccess('Deal updated successfully!');
                    
                    editingDeal = null;
                    document.getElementById('dealFormTitle').textContent = 'Add New Deal';
                    document.getElementById('dealSubmitBtn').textContent = 'Add Deal';
                    document.getElementById('dealCancelBtn').style.display = 'none';
                } else {
                    const { error } = await supabaseClient.from('deals').insert([dealData]);
                    if (error) throw error;
                    showSuccess('Deal created successfully!');
                }
                
                editingDeal = null;
                document.getElementById('dealForm').reset();
                uploadedDealImage = null;
                renderDealImagePreview();
                document.getElementById('dealFormTitle').textContent = 'Add New Deal';
                document.getElementById('dealSubmitBtn').textContent = 'Add Deal';
                document.getElementById('dealCancelBtn').style.display = 'none';
                loadDeals();
                
                switchPage('all-deals');
            } catch (error) {
                showError('Error creating deal: ' + error.message);
            }
        });

        function getNextDayOfWeek(baseDate, dayName, weekOffset) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const targetDay = days.indexOf(dayName);
            const date = new Date(baseDate);
            
            const currentDay = date.getDay();
            let daysUntilTarget = targetDay - currentDay;
            if (daysUntilTarget < 0) daysUntilTarget += 7;
            
            date.setDate(date.getDate() + daysUntilTarget + (weekOffset * 7));
            return date;
        }

        async function loadDeals() {
            const listDiv = document.getElementById('dealsList');
            listDiv.innerHTML = '<div class="loading">Loading deals...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('deals')
                    .select(`
                        *,
                        venues!deals_venue_id_fkey(name, location_short)
                    `)
                    .order('deal_date', { ascending: false });
                    
                if (error) throw error;
                
                allDeals = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No deals yet! Create your first deal using the form above.</p>';
                    return;
                }
                
                renderDeals(data);
            } catch (error) {
                showError('Error loading deals: ' + error.message);
                listDiv.innerHTML = '<p style="text-align:center;color:#e74c3c;">Error loading deals. Check console for details.</p>';
            }
        }

        function renderDeals(deals) {
            const listDiv = document.getElementById('dealsList');
            
            if (deals.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No deals match your filters.</p>';
                return;
            }
            
            listDiv.innerHTML = deals.map(deal => `
                    <div class="venue-item">
                        <div class="status-indicator ${deal.active ? 'status-active' : 'status-inactive'}" title="${deal.active ? 'Active' : 'Inactive'}"></div>
                        <div class="venue-info">
                            <h3>${deal.name}</h3>
                            <p><strong>Category:</strong> ${deal.category || 'N/A'}</p>
                            <p><strong>Venue:</strong> ${deal.venues?.name || 'N/A'} - ${deal.venues?.location_short || ''}</p>
                            <p><strong>Date:</strong> ${deal.deal_date} ${deal.start_time ? `(${deal.start_time} - ${deal.end_time})` : ''}</p>
                            ${deal.is_recurring ? `<p><strong>Recurring:</strong> ${deal.recurring_day} (${deal.recurring_weeks} weeks)</p>` : ''}
                            <p><strong>Price:</strong> ${deal.price || 'N/A'} | <strong>Status:</strong> ${deal.active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                            ${deal.image_url ? '<p><strong>Image:</strong> üì∏</p>' : ''}
                        </div>
                        <div class="venue-actions">
                            ${!deal.active ? `<button class="reactivate" onclick="reactivateDeal(${deal.id})">üîÑ Reactivate</button>` : ''}
                            ${deal.active ? 
                                `<button class="reactivate" onclick="pauseDeal(${deal.id}, '${deal.name.replace(/'/g, "\\'")}')">‚è∏Ô∏è Pause</button>` : 
                                `<button class="reactivate" onclick="unpauseDeal(${deal.id}, '${deal.name.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è Unpause</button>`
                            }
                            <button class="edit" onclick="editDeal(${deal.id})">Edit</button>
                            <button class="delete" onclick="deleteDeal(${deal.id}, '${deal.name.replace(/'/g, "\\'")}')" >Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function filterDeals() {
            const searchTerm = document.getElementById('dealSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('dealCategoryFilter').value;
            const statusFilter = document.getElementById('dealStatusFilter').value;
            
            let filtered = allDeals;
            
            if (searchTerm) {
                filtered = filtered.filter(d => d.name.toLowerCase().includes(searchTerm));
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(d => d.category === categoryFilter);
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(d => d.active === true);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(d => d.active === false);
            }
            
            const resultsDiv = document.getElementById('dealFilterResults');
            if (searchTerm || categoryFilter || statusFilter !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allDeals.length} deals`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderDeals(filtered);
        }

        async function reactivateDeal(id) {
            try {
                const { data, error } = await supabaseClient.from('deals').select('*').eq('id', id).single();
                if (error) throw error;
                
                editingDeal = id;
                document.getElementById('dealFormTitle').textContent = 'Reactivate Deal - Set New Date';
                document.getElementById('dealSubmitBtn').textContent = 'Reactivate Deal';
                document.getElementById('dealCancelBtn').style.display = 'inline-block';
                
                switchPage('add-deal');
                
                document.getElementById('deal_name').value = data.name || '';
                document.getElementById('deal_category').value = data.category || '';
                document.getElementById('deal_description').value = data.description || '';
                document.getElementById('deal_phone').value = data.phone || '';
                document.getElementById('deal_venue_link').value = data.venue_id || '';
                document.getElementById('deal_date').value = '';
                document.getElementById('deal_start_time').value = data.start_time || '12:00';
                document.getElementById('deal_end_time').value = data.end_time || '12:00';
                document.getElementById('deal_price').value = data.price || '';
                document.getElementById('deal_price_range').value = data.price_range || '';
                document.getElementById('deal_views').value = 0;
                
                document.getElementById('deal_registered_date').value = new Date().toISOString().split('T')[0];
                
                uploadedDealImage = data.image_url || null;
                renderDealImagePreview();
                
                if (data.is_recurring) {
                    document.getElementById('deal_repeat').checked = true;
                    toggleRepeatOptions();
                    
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    
                    if (data.recurring_weeks) {
                        document.getElementById('repeat_weeks').value = data.recurring_weeks;
                    }
                } else {
                    document.getElementById('deal_repeat').checked = false;
                    toggleRepeatOptions();
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showSuccess('Set a new date and click "Reactivate Deal" to make this deal active again!');
            } catch (error) {
                showError('Error loading deal: ' + error.message);
            }
        }

        async function deleteDeal(id, name) {
            if (!confirm(`Delete deal "${name}"?`)) return;
            
            try {
                const { error } = await supabaseClient.from('deals').delete().eq('id', id);
                if (error) throw error;
                showSuccess('Deal deleted!');
                loadDeals();
            } catch (error) {
                showError('Error deleting deal: ' + error.message);
            }
        }

        async function pauseDeal(id, name) {
            if (!confirm(`Pause "${name}"? It will be hidden from the app.`)) return;
            try {
                const { error } = await supabaseClient.from('deals').update({ active: false }).eq('id', id);
                if (error) throw error;
                showSuccess('Deal paused!');
                loadDeals();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function unpauseDeal(id, name) {
            if (!confirm(`Unpause "${name}"? It will be visible in the app again.`)) return;
            try {
                const { error } = await supabaseClient.from('deals').update({ active: true }).eq('id', id);
                if (error) throw error;
                showSuccess('Deal unpaused!');
                loadDeals();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function editDeal(id) {
            try {
                const { data, error } = await supabaseClient.from('deals').select('*').eq('id', id).single();
                if (error) throw error;
                
                editingDeal = id;
                document.getElementById('dealFormTitle').textContent = 'Edit Deal';
                document.getElementById('dealSubmitBtn').textContent = 'Update Deal';
                document.getElementById('dealCancelBtn').style.display = 'inline-block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-deal-page').classList.add('active');
                
                document.getElementById('deal_name').value = data.name || '';
                document.getElementById('deal_category').value = data.category || '';
                document.getElementById('deal_description').value = data.description || '';
                document.getElementById('deal_phone').value = data.phone || '';
                document.getElementById('deal_venue_link').value = data.venue_id || '';
                document.getElementById('deal_date').value = data.deal_date || '';
                document.getElementById('deal_start_time').value = data.start_time || '12:00';
                document.getElementById('deal_end_time').value = data.end_time || '12:00';
                document.getElementById('deal_price').value = data.price || '';
                document.getElementById('deal_price_range').value = data.price_range || '';
                document.getElementById('deal_views').value = data.views || 0;
                
                const dealRegisteredDate = data.registered_date || new Date().toISOString().split('T')[0];
                document.getElementById('deal_registered_date').value = dealRegisteredDate;
                
                uploadedDealImage = data.image_url || null;
                renderDealImagePreview();
                
                if (data.is_recurring) {
                    document.getElementById('deal_repeat').checked = true;
                    toggleRepeatOptions();
                    
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    
                    if (data.recurring_weeks) {
                        document.getElementById('repeat_weeks').value = data.recurring_weeks;
                    }
                } else {
                    document.getElementById('deal_repeat').checked = false;
                    toggleRepeatOptions();
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                showError('Error loading deal: ' + error.message);
            }
        }

        async function loadVenuesForDealDropdown() {
            try {
                const { data, error } = await supabaseClient.from('venues').select('id, name, location_short').order('name', { ascending: true });
                if (error) throw error;
                
                const dropdown = document.getElementById('deal_venue_link');
                dropdown.innerHTML = '<option value="">Select venue...</option>';
                
                data.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue.id;
                    option.textContent = venue.name;
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading venues for dropdown:', error);
            }
        }

        // ===== EVENTS JAVASCRIPT =====
        let editingEvent = null;
        let uploadedEventImage = null;
        let allEvents = [];

        setTimeout(() => {
            const eventImageInput = document.getElementById('eventImageInput');
            if (eventImageInput) {
                eventImageInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (!file.type.startsWith('image/')) {
                        showError('Please select an image file');
                        return;
                    }
                    await uploadEventImage(file);
                });
            }
        }, 1000);

        async function uploadEventImage(file) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `event-${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const { data, error } = await supabaseClient.storage.from('venue-images').upload(fileName, file);
                if (error) throw error;
                const { data: { publicUrl } } = supabaseClient.storage.from('venue-images').getPublicUrl(fileName);
                uploadedEventImage = publicUrl;
                renderEventImagePreview();
                showSuccess('Image uploaded!');
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        function renderEventImagePreview() {
            const container = document.getElementById('eventImagePreview');
            if (!container) return;
            if (!uploadedEventImage) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `<div class="image-preview-item main-image"><img src="${uploadedEventImage}" alt="Event image"><div class="main-badge">MAIN</div><button type="button" class="remove-image" onclick="removeEventImage()">√ó</button></div>`;
        }

        function removeEventImage() {
            uploadedEventImage = null;
            renderEventImagePreview();
            const input = document.getElementById('eventImageInput');
            if (input) input.value = '';
        }

        function toggleEventRepeatOptions() {
            const checkbox = document.getElementById('event_repeat');
            const repeatOptions = document.getElementById('eventRepeatOptions');
            if (checkbox && repeatOptions) {
                if (checkbox.checked) {
                    repeatOptions.classList.remove('hidden');
                } else {
                    repeatOptions.classList.add('hidden');
                }
            }
        }

        function cancelEventEdit() {
            editingEvent = null;
            const form = document.getElementById('eventForm');
            if (form) form.reset();
            const title = document.getElementById('eventFormTitle');
            if (title) title.textContent = 'Add New Event';
            const submitBtn = document.getElementById('eventSubmitBtn');
            if (submitBtn) submitBtn.textContent = 'Add Event';
            const cancelBtn = document.getElementById('eventCancelBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';
            uploadedEventImage = null;
            renderEventImagePreview();
        }

        setTimeout(() => {
            const eventForm = document.getElementById('eventForm');
            if (eventForm) {
                eventForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const repeatDaysCheckboxes = document.querySelectorAll('input[name="event_repeat_days"]:checked');
                    const repeatDays = Array.from(repeatDaysCheckboxes).map(cb => cb.value);
                    const repeatWeeks = parseInt(document.getElementById('event_repeat_weeks').value) || 0;
                    const eventData = {
                        name: document.getElementById('event_name').value,
                        category: document.getElementById('event_category').value,
                        description: document.getElementById('event_description').value,
                        phone: document.getElementById('event_phone').value,
                        website: document.getElementById('event_website').value || null,
                        event_date: document.getElementById('event_date').value,
                        start_time: document.getElementById('event_start_time').value || null,
                        end_time: document.getElementById('event_end_time').value || null,
                        is_recurring: document.getElementById('event_repeat').checked,
                        recurring_day: (document.getElementById('event_repeat').checked && repeatDays.length > 0) ? repeatDays.join(',') : null,
                        recurring_weeks: (document.getElementById('event_repeat').checked && repeatWeeks > 0) ? repeatWeeks : null,
                        price: document.getElementById('event_price').value,
                        image_url: uploadedEventImage,
                        views: parseInt(document.getElementById('event_views').value) || 0,
                        registered_date: editingEvent ? (document.getElementById('event_registered_date').value || null) : (document.getElementById('event_registered_date').value || new Date().toISOString().split('T')[0]),
                        active: true
                    };
                    try {
                        if (editingEvent) {
                            const { error } = await supabaseClient.from('events').update(eventData).eq('id', editingEvent);
                            if (error) throw error;
                            showSuccess('Event updated successfully!');
                        } else {
                            const { error } = await supabaseClient.from('events').insert([eventData]);
                            if (error) throw error;
                            showSuccess('Event created successfully!');
                        }
                        cancelEventEdit();
                        loadEvents();
                        switchPage('all-events');
                    } catch (error) {
                        showError('Error: ' + error.message);
                    }
                });
            }
        }, 1000);

        async function loadEvents() {
            const listDiv = document.getElementById('eventsList');
            if (!listDiv) return;
            listDiv.innerHTML = '<div class="loading">Loading events...</div>';
            try {
                const { data, error } = await supabaseClient.from('events').select('*').order('event_date', { ascending: false });
                if (error) throw error;
                allEvents = data;
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No events yet!</p>';
                    return;
                }
                renderEvents(data);
            } catch (error) {
                showError('Error loading events: ' + error.message);
                listDiv.innerHTML = '<p style="text-align:center;color:#e74c3c;">Error loading events.</p>';
            }
        }

        function renderEvents(events) {
            const listDiv = document.getElementById('eventsList');
            if (!listDiv) return;
            if (events.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No events match your filters.</p>';
                return;
            }
            listDiv.innerHTML = events.map(event => `
                <div class="venue-item">
                    <div class="status-indicator ${event.active ? 'status-active' : 'status-inactive'}" title="${event.active ? 'Active' : 'Inactive'}"></div>
                    <div class="venue-info">
                        <h3>${event.name}</h3>
                        <p><strong>Category:</strong> ${event.category || 'N/A'}</p>
                        ${event.website ? `<p><strong>Website:</strong> <a href="${event.website}" target="_blank">${event.website}</a></p>` : ''}
                        <p><strong>Date:</strong> ${event.event_date} ${event.start_time ? `(${event.start_time} - ${event.end_time})` : ''}</p>
                        ${event.is_recurring ? `<p><strong>Recurring:</strong> ${event.recurring_day} (${event.recurring_weeks} weeks)</p>` : ''}
                        <p><strong>Price:</strong> ${event.price || 'Free'} | <strong>Status:</strong> ${event.active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                        ${event.image_url ? '<p><strong>Image:</strong> üì∏</p>' : ''}
                    </div>
                    <div class="venue-actions">
                        ${!event.active ? `<button class="reactivate" onclick="reactivateEvent(${event.id})">üîÑ Reactivate</button>` : ''}
                        ${event.active ? 
                            `<button class="reactivate" onclick="pauseEvent(${event.id}, '${event.name.replace(/'/g, "\\'")}')">‚è∏Ô∏è Pause</button>` : 
                            `<button class="reactivate" onclick="unpauseEvent(${event.id}, '${event.name.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è Unpause</button>`
                        }
                        <button class="edit" onclick="editEvent(${event.id})">Edit</button>
                        <button class="delete" onclick="deleteEvent(${event.id}, '${event.name.replace(/'/g, "\\'")}')" >Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterEvents() {
            const searchTerm = document.getElementById('eventSearch')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('eventCategoryFilter')?.value || '';
            const statusFilter = document.getElementById('eventStatusFilter')?.value || 'all';
            let filtered = allEvents;
            if (searchTerm) filtered = filtered.filter(e => e.name.toLowerCase().includes(searchTerm));
            if (categoryFilter) filtered = filtered.filter(e => e.category === categoryFilter);
            if (statusFilter === 'active') filtered = filtered.filter(e => e.active === true);
            else if (statusFilter === 'inactive') filtered = filtered.filter(e => e.active === false);
            const resultsDiv = document.getElementById('eventFilterResults');
            if (resultsDiv) {
                if (searchTerm || categoryFilter || statusFilter !== 'all') {
                    resultsDiv.style.display = 'block';
                    resultsDiv.textContent = `Showing ${filtered.length} of ${allEvents.length} events`;
                } else {
                    resultsDiv.style.display = 'none';
                }
            }
            renderEvents(filtered);
        }

        async function editEvent(id) {
            try {
                const { data, error } = await supabaseClient.from('events').select('*').eq('id', id).single();
                if (error) throw error;
                editingEvent = id;
                document.getElementById('eventFormTitle').textContent = 'Edit Event';
                document.getElementById('eventSubmitBtn').textContent = 'Update Event';
                document.getElementById('eventCancelBtn').style.display = 'inline-block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-event-page').classList.add('active');
                
                document.getElementById('event_name').value = data.name || '';
                document.getElementById('event_category').value = data.category || '';
                document.getElementById('event_description').value = data.description || '';
                document.getElementById('event_phone').value = data.phone || '';
                document.getElementById('event_website').value = data.website || '';
                document.getElementById('event_date').value = data.event_date || '';
                document.getElementById('event_start_time').value = data.start_time || '20:00';
                document.getElementById('event_end_time').value = data.end_time || '23:00';
                document.getElementById('event_price').value = data.price || '';
                document.getElementById('event_views').value = data.views || 0;
                document.getElementById('event_registered_date').value = data.registered_date || '';
                uploadedEventImage = data.image_url || null;
                renderEventImagePreview();
                if (data.is_recurring) {
                    document.getElementById('event_repeat').checked = true;
                    toggleEventRepeatOptions();
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="event_repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    if (data.recurring_weeks) document.getElementById('event_repeat_weeks').value = data.recurring_weeks;
                } else {
                    document.getElementById('event_repeat').checked = false;
                    toggleEventRepeatOptions();
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                showError('Error loading event: ' + error.message);
            }
        }

        async function reactivateEvent(id) {
            try {
                const { data, error } = await supabaseClient.from('events').select('*').eq('id', id).single();
                if (error) throw error;
                editingEvent = id;
                document.getElementById('eventFormTitle').textContent = 'Reactivate Event - Set New Date';
                document.getElementById('eventSubmitBtn').textContent = 'Reactivate Event';
                document.getElementById('eventCancelBtn').style.display = 'inline-block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-event-page').classList.add('active');
                
                document.getElementById('event_name').value = data.name || '';
                document.getElementById('event_category').value = data.category || '';
                document.getElementById('event_description').value = data.description || '';
                document.getElementById('event_phone').value = data.phone || '';
                document.getElementById('event_website').value = data.website || '';
                document.getElementById('event_date').value = '';
                document.getElementById('event_start_time').value = data.start_time || '20:00';
                document.getElementById('event_end_time').value = data.end_time || '23:00';
                document.getElementById('event_price').value = data.price || '';
                document.getElementById('event_views').value = 0;
                document.getElementById('event_registered_date').value = '';
                uploadedEventImage = data.image_url || null;
                renderEventImagePreview();
                if (data.is_recurring) {
                    document.getElementById('event_repeat').checked = true;
                    toggleEventRepeatOptions();
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="event_repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    if (data.recurring_weeks) document.getElementById('event_repeat_weeks').value = data.recurring_weeks;
                } else {
                    document.getElementById('event_repeat').checked = false;
                    toggleEventRepeatOptions();
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showSuccess('Set a new date and click "Reactivate Event"!');
            } catch (error) {
                showError('Error loading event: ' + error.message);
            }
        }

        async function deleteEvent(id, name) {
            if (!confirm(`Delete event "${name}"?`)) return;
            try {
                const { error } = await supabaseClient.from('events').delete().eq('id', id);
                if (error) throw error;
                showSuccess('Event deleted!');
                loadEvents();
            } catch (error) {
                showError('Error deleting event: ' + error.message);
            }
        }

        async function pauseEvent(id, name) {
            if (!confirm(`Pause "${name}"? It will be hidden from the app.`)) return;
            try {
                const { error } = await supabaseClient.from('events').update({ active: false }).eq('id', id);
                if (error) throw error;
                showSuccess('Event paused!');
                loadEvents();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function unpauseEvent(id, name) {
            if (!confirm(`Unpause "${name}"? It will be visible in the app again.`)) return;
            try {
                const { error } = await supabaseClient.from('events').update({ active: true }).eq('id', id);
                if (error) throw error;
                showSuccess('Event unpaused!');
                loadEvents();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // ===== VISITORS & CUSTOMERS JAVASCRIPT =====
        async function loadVisitors() {
            const listDiv = document.getElementById('visitorsList');
            listDiv.innerHTML = '<div class="loading">Loading visitors...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('id, email, name, created_at, user_type')
                    .eq('user_type', 'visitor')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allVisitors = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No visitors yet!</p>';
                    return;
                }
                
                renderVisitors(data);
            } catch (error) {
                showError('Error loading visitors: ' + error.message);
            }
        }

        function renderVisitors(visitors) {
            const listDiv = document.getElementById('visitorsList');
            
            if (visitors.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No visitors match your search.</p>';
                return;
            }
            
            listDiv.innerHTML = visitors.map(v => `
                <div class="venue-item">
                    <div class="venue-info">
                        <h3>${v.name || 'No name'}</h3>
                        <p><strong>Email:</strong> ${v.email}</p>
                        <p><strong>Registered:</strong> ${new Date(v.created_at).toLocaleDateString('sv-SE')}</p>
                        <p><strong>Type:</strong> üë• Visitor</p>
                    </div>
                    <div class="venue-actions">
                        <button class="edit" onclick="editVisitor('${v.id}', '${v.name || ''}')">Edit</button>
                        <button class="delete" onclick="deleteVisitor('${v.id}', '${(v.name || 'this visitor').replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterVisitors() {
            const searchTerm = document.getElementById('visitorSearch').value.toLowerCase();
            
            let filtered = allVisitors;
            
            if (searchTerm) {
                filtered = filtered.filter(v => 
                    (v.name && v.name.toLowerCase().includes(searchTerm)) || 
                    (v.email && v.email.toLowerCase().includes(searchTerm))
                );
            }
            
            const resultsDiv = document.getElementById('visitorFilterResults');
            if (searchTerm) {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allVisitors.length} visitors`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderVisitors(filtered);
        }

        async function loadCustomers() {
            const listDiv = document.getElementById('customersList');
            listDiv.innerHTML = '<div class="loading">Loading customers...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select(`
                        id,
                        email,
                        name,
                        user_type,
                        venue_id,
                        is_active,
                        created_at,
                        venues!profiles_venue_id_fkey(id, name, credits, subscription_status, subscription_expires_at)
                    `)
                    .eq('user_type', 'venue')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allCustomers = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No venue customers yet!</p>';
                    return;
                }
                
                renderCustomers(data);
            } catch (error) {
                showError('Error loading customers: ' + error.message);
            }
        }

        function renderCustomers(customers) {
            const listDiv = document.getElementById('customersList');
            
            if (customers.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No customers match your filters.</p>';
                return;
            }
            
            listDiv.innerHTML = customers.map(c => `
                <div class="venue-item">
                    <div class="status-indicator ${c.is_active ? 'status-active' : 'status-inactive'}" title="${c.is_active ? 'Active' : 'Inactive'}"></div>
                    <div class="venue-info">
                        <h3>${c.venues?.name || 'No venue linked'}</h3>
                        <p><strong>Email:</strong> ${c.email}</p>
                        <p><strong>Credits:</strong> ${c.venues?.credits || 0}</p>
                        <p><strong>Subscription:</strong> ${c.venues?.subscription_status || 'inactive'}</p>
                        ${c.venues?.subscription_expires_at ? `<p><strong>Expires:</strong> ${new Date(c.venues.subscription_expires_at).toLocaleDateString('sv-SE')}</p>` : ''}
                        <p><strong>Registered:</strong> ${new Date(c.created_at).toLocaleDateString('sv-SE')}</p>
                        <p><strong>Status:</strong> ${c.is_active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                    </div>
                    <div class="venue-actions">
                        ${c.is_active ? 
                            `<button class="reactivate" onclick="deactivateCustomer('${c.id}', '${c.venues?.name || 'this customer'}')">‚è∏Ô∏è Deactivate</button>` : 
                            `<button class="reactivate" onclick="activateCustomer('${c.id}', '${c.venues?.name || 'this customer'}')">‚ñ∂Ô∏è Activate</button>`
                        }
                        <button class="edit" onclick="editCustomer('${c.id}', ${c.venues?.credits || 0}, ${c.venue_id})">Edit Credits</button>
                        <button class="delete" onclick="deleteCustomer('${c.id}', '${c.venues?.name || 'this customer'}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const statusFilter = document.getElementById('customerStatusFilter').value;
            
            let filtered = allCustomers;
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                    (c.venues?.name && c.venues.name.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(c => c.is_active === true);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(c => c.is_active === false);
            }
            
            const resultsDiv = document.getElementById('customerFilterResults');
            if (searchTerm || statusFilter !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allCustomers.length} customers`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderCustomers(filtered);
        }

        async function activateCustomer(profileId, venueName) {
            if (!confirm(`Activate "${venueName}"?`)) return;
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ is_active: true })
                    .eq('id', profileId);
                
                if (error) throw error;
                showSuccess('Customer activated!');
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function deactivateCustomer(profileId, venueName) {
            if (!confirm(`Deactivate "${venueName}"? They won't be able to log in.`)) return;
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ is_active: false })
                    .eq('id', profileId);
                
                if (error) throw error;
                showSuccess('Customer deactivated!');
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // ===== MODAL FUNCTIONS - NYA FUNKTIONER! =====
        
        // VISITOR MODAL FUNCTIONS
       function editVisitor(visitorId, currentName) {
    currentEditingVisitorId = visitorId;
    document.getElementById('modal_visitor_name').value = currentName;
    document.getElementById('editVisitorModal').classList.add('active');
}
        
        function closeVisitorModal() {
            document.getElementById('editVisitorModal').classList.remove('active');
            currentEditingVisitorId = null;
        }
        
        async function saveVisitor() {
    if (!currentEditingVisitorId) return;
    
    const newName = document.getElementById('modal_visitor_name').value;
    
    if (!newName) {
        showError('Name is required!');
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('profiles')
            .update({ 
                name: newName
            })
            .eq('id', currentEditingVisitorId);
        
        if (error) throw error;
        showSuccess('Visitor updated!');
        closeVisitorModal();
        loadVisitors();
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

        // CUSTOMER MODAL FUNCTIONS
        function editCustomer(customerId, currentCredits, venueId) {
            currentEditingCustomerId = customerId;
            document.getElementById('modal_customer_credits').value = currentCredits;
            document.getElementById('modal_customer_credits').dataset.venueId = venueId;
            document.getElementById('editCustomerModal').classList.add('active');
        }
        
        function closeCustomerModal() {
            document.getElementById('editCustomerModal').classList.remove('active');
            currentEditingCustomerId = null;
        }
        
        async function saveCustomer() {
            if (!currentEditingCustomerId) return;
            
            const newCredits = parseInt(document.getElementById('modal_customer_credits').value);
            const venueId = parseInt(document.getElementById('modal_customer_credits').dataset.venueId);
            
            if (isNaN(newCredits)) {
                showError('Please enter a valid number for credits!');
                return;
            }
            
            if (!venueId) {
                showError('No venue linked!');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('venues')
                    .update({ credits: newCredits })
                    .eq('id', venueId);
                
                if (error) throw error;
                showSuccess('Credits updated!');
                closeCustomerModal();
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function deleteVisitor(visitorId, visitorName) {
            if (!confirm(`Delete visitor "${visitorName}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .delete()
                    .eq('id', visitorId);
                
                if (error) throw error;
                showSuccess('Visitor deleted!');
                loadVisitors();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function deleteCustomer(customerId, venueName) {
            if (!confirm(`Delete "${venueName}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .delete()
                    .eq('id', customerId);
                
                if (error) throw error;
                showSuccess('Customer deleted!');
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

    </script>
</body>
</html>