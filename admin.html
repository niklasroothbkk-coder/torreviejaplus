<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TorreviejaPlus Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f0f1;
            min-height: 100vh;
            display: flex;
        }
        
        /* WordPress-style Sidebar */
        .sidebar {
            width: 260px;
            background: #23282d;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            background: #191e23;
            border-bottom: 1px solid #32373c;
        }
        
        .sidebar-header h1 {
            color: white;
            font-size: 20px;
            margin: 0;
        }
        
        .sidebar-menu {
            padding: 10px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            color: #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            text-decoration: none;
        }
        
        .menu-item:hover {
            background: #32373c;
            color: #00b9eb;
        }
        
        .menu-item.active {
            background: #0073aa;
            border-left-color: #00b9eb;
            color: white;
        }
        
        .menu-item span {
            font-size: 20px;
        }
        
        /* Main Content Area */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 20px 40px;
        }
        
        .page-header {
            margin-bottom: 30px;
            border-bottom: 1px solid #ccd0d4;
            padding-bottom: 15px;
        }
        
        .page-header h1 {
            color: #23282d;
            font-size: 23px;
            font-weight: 400;
            margin: 0;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #23282d; text-align: left; margin-bottom: 20px; font-size: 23px; font-weight: 400; }
        .panel {
            background: white;
            border-radius: 0;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.04);
            border: 1px solid #c3c4c7;
        }
        h2 {
            color: #23282d;
            margin-bottom: 20px;
            border-bottom: 1px solid #c3c4c7;
            padding-bottom: 10px;
            font-size: 20px;
            font-weight: 400;
        }
        .form-group { margin-bottom: 20px; }
        .form-group.hidden { display: none; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 600; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button {
            background: #2271b1;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            box-shadow: 0 1px 0 #2271b1;
        }
        button:hover { background: #135e96; box-shadow: 0 1px 0 #135e96; }
        button.delete { background: #b32d2e; box-shadow: 0 1px 0 #b32d2e; }
        button.delete:hover { background: #8a2424; box-shadow: 0 1px 0 #8a2424; }
        button.edit { background: #2271b1; padding: 6px 12px; font-size: 13px; box-shadow: 0 1px 0 #2271b1; }
        button.edit:hover { background: #135e96; box-shadow: 0 1px 0 #135e96; }
        button.reactivate { background: #00a32a; padding: 6px 12px; font-size: 13px; box-shadow: 0 1px 0 #00a32a; }
        button.reactivate:hover { background: #008a20; box-shadow: 0 1px 0 #008a20; }
        .venue-item {
            background: #f6f7f7;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 0;
            border-left: 4px solid #2271b1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #c3c4c7;
            position: relative;
        }
        .status-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .status-active {
            background: #00a32a;
        }
        .status-inactive {
            background: #d63638;
        }
        .venue-info h3 { color: #333; margin-bottom: 5px; text-align: left; }
        .venue-info p { color: #666; margin: 3px 0; font-size: 14px; text-align: left; } 
        .venue-actions { display: flex; gap: 10px; }
        .success {
            background: #00a32a;
            color: white;
            padding: 12px 15px;
            border-radius: 0;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #008a20;
        }
        .error {
            background: #d63638;
            color: white;
            padding: 12px 15px;
            border-radius: 0;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #b02a2c;
        }
        .loading { text-align: center; padding: 20px; color: #666; }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .checkbox-label:hover {
            background: #f8f9fa;
        }
        .checkbox-label input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        .image-upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .image-upload-section input[type="file"] { display: none; }
        .upload-btn {
            background: #2271b1;
            color: white;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            display: inline-block;
            margin: 10px 0;
            font-size: 14px;
            box-shadow: 0 1px 0 #2271b1;
        }
        .upload-btn:hover { background: #135e96; box-shadow: 0 1px 0 #135e96; }
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid transparent;
        }
        .image-preview-item.main-image { border-color: #00a32a; }
        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #b32d2e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        .image-preview-item .main-badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: #00a32a;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        .upload-info {
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }
        .hours-row {
            display: grid;
            grid-template-columns: 90px 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        .hours-row label {
            margin: 0;
            font-weight: 600;
        }
        
        /* Content Pages */
        .content-page {
            display: none;
        }
        
        .content-page.active {
            display: block;
        }
        
        /* Venue Filters */
        .venue-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #c3c4c7;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #2271b1;
        }
        
        .category-filter select {
            padding: 10px 15px;
            border: 1px solid #c3c4c7;
            border-radius: 3px;
            font-size: 14px;
            min-width: 200px;
            background: white;
        }
        
        .category-filter select:focus {
            outline: none;
            border-color: #2271b1;
        }
        
        .filter-results {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* Credentials Section Styling */
        .credentials-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .credentials-section h2 {
            color: #856404;
            border-color: #ffc107;
            margin-bottom: 15px;
        }
        .credentials-note {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .credentials-note p {
            margin: 0;
            color: #155724;
            font-size: 13px;
        }

        /* EDIT MODAL STYLES */
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .edit-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #c3c4c7;
        }
        
        .modal-header h2 {
            margin: 0;
            padding: 0;
            border: none;
            font-size: 22px;
            color: #23282d;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
        }

        /* Dashboard Tabs */
        .dash-tab {
            padding: 8px 0;
            cursor: pointer;
            color: #666;
            font-size: 15px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .dash-tab:hover {
            color: #23282d;
        }
        .dash-tab.active {
            color: #23282d;
            border-bottom-color: #23282d;
        }
        .dash-content {
            display: none;
        }
        .dash-content.active {
            display: block;
        }
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- WordPress-style Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header" onclick="switchPage('dashboard')" style="cursor: pointer;">
            <h1>üèñÔ∏è TorreviejaPlus</h1>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="switchPage('dashboard')">
                <span>üè†</span>
                <div>Dashboard</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('all-venues')">
                <span>üìã</span>
                <div>All Venues</div>
            </div>
            <div class="menu-item" onclick="switchPage('add-venue')">
                <span style="color: white;">‚ûï</span>
                <div>Add Venue</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('all-deals')">
                <span>üéØ</span>
                <div>All Deals</div>
            </div>
            <div class="menu-item" onclick="switchPage('add-deal')">
                <span style="color: white;">‚ûï</span>
                <div>New Deal</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('all-events')">
                <span>üéâ</span>
                <div>All Events</div>
            </div>
            <div class="menu-item" onclick="switchPage('add-event')">
                <span style="color: white;">‚ûï</span>
                <div>New Event</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('visitors')">
                <span>üë•</span>
                <div>Visitors</div>
            </div>
            <div class="menu-item" onclick="switchPage('customers')">
                <span>üè™</span>
                <div>Customers (Venues)</div>
            </div>
            <div style="height: 1px; background: #32373c; margin: 10px 0;"></div>
            <div class="menu-item" onclick="switchPage('packages')">
                <span>üì¶</span>
                <div>Packages</div>
            </div>
        </div>
    </div>

    <!-- EDIT VISITOR MODAL -->
    <div id="editVisitorModal" class="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Visitor</h2>
            </div>
            <div class="form-group">
                <label for="modal_visitor_name">Name</label>
                <input type="text" id="modal_visitor_name" placeholder="Enter name...">
            </div>
            <div class="modal-buttons">
                <button onclick="closeVisitorModal()" style="background: #95a5a6;">Cancel</button>
                <button onclick="saveVisitor()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- EDIT CUSTOMER MODAL -->
    <div id="editCustomerModal" class="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Customer</h2>
            </div>
            <div class="form-group">
                <label for="modal_customer_credits">Credits</label>
                <input type="number" id="modal_customer_credits" placeholder="Enter credits amount...">
            </div>
            <div class="modal-buttons">
                <button onclick="closeCustomerModal()" style="background: #95a5a6;">Cancel</button>
                <button onclick="saveCustomer()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="container">
            <div id="successMessage" class="success"></div>
            <div id="errorMessage" class="error"></div>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="content-page active">
                <div class="page-header" style="display: flex; align-items: center; justify-content: space-between; border-bottom: none; padding-bottom: 0; margin-bottom: 0;">
                    <h1 style="margin: 0;">Dashboard</h1>
                    <div class="dashboard-tabs" style="display: flex; gap: 30px;">
                        <span class="dash-tab active" onclick="switchDashTab('analytics')" id="tab-analytics">Analytics</span>
                        <span class="dash-tab" onclick="switchDashTab('payments')" id="tab-payments">Payments</span>
                        <span class="dash-tab" onclick="switchDashTab('reviews')" id="tab-reviews">Reviews</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="dashboardPeriod" onchange="updateDashboardPeriod()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                            <option value="30">Past 30 Days</option>
                            <option value="7">Past 7 Days</option>
                            <option value="90">Past 90 Days</option>
                            <option value="365">Past Year</option>
                        </select>
                        <span id="dashboardDateRange" style="color: #666; font-size: 13px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;"></span>
                    </div>
                </div>

                <!-- Analytics Tab Content -->
                <div id="dashboard-analytics" class="dash-content active">
                    <!-- Stats Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0;">
                        <!-- All Visitors Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">All Visitors</p>
                                    <h2 id="stat-visitors" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-visitors-percent" style="color: #22c55e; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-visitors-bar" style="width: 0%; height: 100%; background: #22c55e; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <circle cx="30" cy="60" r="12" fill="#e0d4f7"/>
                                        <circle cx="70" cy="60" r="12" fill="#a78bfa"/>
                                        <circle cx="50" cy="45" r="15" fill="#7c3aed"/>
                                        <rect x="20" y="72" width="20" height="20" rx="4" fill="#e0d4f7"/>
                                        <rect x="40" y="60" width="20" height="32" rx="4" fill="#7c3aed"/>
                                        <rect x="60" y="72" width="20" height="20" rx="4" fill="#a78bfa"/>
                                        <circle cx="75" cy="25" r="10" fill="#f472b6" opacity="0.8"/>
                                        <text x="75" y="29" text-anchor="middle" fill="white" font-size="12" font-weight="bold">%</text>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Impressions Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Impressions</p>
                                    <h2 id="stat-impressions" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-impressions-percent" style="color: #f59e0b; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-impressions-bar" style="width: 0%; height: 100%; background: #f59e0b; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <rect x="25" y="20" width="50" height="70" rx="8" fill="#a78bfa"/>
                                        <rect x="30" y="30" width="40" height="30" rx="4" fill="#e0d4f7"/>
                                        <circle cx="50" cy="75" r="6" fill="#e0d4f7"/>
                                        <circle cx="75" cy="35" r="8" fill="#22c55e"/>
                                        <path d="M72 35 L75 38 L80 32" stroke="white" stroke-width="2" fill="none"/>
                                        <circle cx="20" cy="50" r="5" fill="#f472b6"/>
                                        <path d="M18 55 Q 10 65 20 70 Q 30 65 22 55" fill="#f472b6"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Total Clicks Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Total Clicks</p>
                                    <h2 id="stat-clicks" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-clicks-percent" style="color: #06b6d4; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-clicks-bar" style="width: 0%; height: 100%; background: #06b6d4; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <rect x="20" y="25" width="45" height="55" rx="6" fill="#a78bfa"/>
                                        <rect x="25" y="35" width="35" height="20" rx="3" fill="white"/>
                                        <circle cx="42" cy="70" r="5" fill="white"/>
                                        <circle cx="70" cy="30" r="12" fill="#06b6d4"/>
                                        <circle cx="70" cy="30" r="6" fill="white"/>
                                        <circle cx="80" cy="60" r="8" fill="#f472b6"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Pageviews Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Pageviews</p>
                                    <h2 id="stat-pageviews" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-revenue-percent" style="color: #ef4444; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-revenue-bar" style="width: 0%; height: 100%; background: #ef4444; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <circle cx="50" cy="55" r="25" fill="#fbbf24"/>
                                        <text x="50" y="62" text-anchor="middle" fill="white" font-size="20" font-weight="bold">‚Ç¨</text>
                                        <circle cx="75" cy="25" r="12" fill="#a78bfa"/>
                                        <circle cx="75" cy="25" r="6" fill="white"/>
                                        <rect x="20" y="70" width="15" height="20" rx="3" fill="#22c55e"/>
                                        <rect x="38" y="65" width="15" height="25" rx="3" fill="#7c3aed"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Second Row Stats Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 0 0 30px 0;">
                        <!-- Venues Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Venues</p>
                                    <h2 id="stat-venues-analytics" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-venues-analytics-percent" style="color: #22c55e; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-venues-analytics-bar" style="width: 0%; height: 100%; background: #22c55e; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <rect x="15" y="40" width="70" height="50" rx="4" fill="#7c3aed"/>
                                        <rect x="25" y="50" width="15" height="15" rx="2" fill="#e0d4f7"/>
                                        <rect x="60" y="50" width="15" height="15" rx="2" fill="#e0d4f7"/>
                                        <rect x="40" y="65" width="20" height="25" rx="2" fill="#e0d4f7"/>
                                        <polygon points="50,15 10,40 90,40" fill="#a78bfa"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Visitors Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Visitors</p>
                                    <h2 id="stat-visitors-analytics" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-visitors-analytics-percent" style="color: #f59e0b; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-visitors-analytics-bar" style="width: 0%; height: 100%; background: #f59e0b; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <circle cx="30" cy="60" r="12" fill="#e0d4f7"/>
                                        <circle cx="70" cy="60" r="12" fill="#a78bfa"/>
                                        <circle cx="50" cy="45" r="15" fill="#7c3aed"/>
                                        <rect x="20" y="72" width="20" height="20" rx="4" fill="#e0d4f7"/>
                                        <rect x="40" y="60" width="20" height="32" rx="4" fill="#7c3aed"/>
                                        <rect x="60" y="72" width="20" height="20" rx="4" fill="#a78bfa"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Active Deals Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Active Deals</p>
                                    <h2 id="stat-deals-analytics" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-deals-analytics-percent" style="color: #06b6d4; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-deals-analytics-bar" style="width: 0%; height: 100%; background: #06b6d4; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <circle cx="50" cy="50" r="35" fill="#7c3aed"/>
                                        <text x="50" y="58" text-anchor="middle" fill="white" font-size="28" font-weight="bold">%</text>
                                        <circle cx="80" cy="25" r="12" fill="#f59e0b"/>
                                        <text x="80" y="30" text-anchor="middle" fill="white" font-size="14" font-weight="bold">‚òÖ</text>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Active Events Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Active Events</p>
                                    <h2 id="stat-events-analytics" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-events-analytics-percent" style="color: #ef4444; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-events-analytics-bar" style="width: 0%; height: 100%; background: #ef4444; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <rect x="20" y="25" width="60" height="60" rx="8" fill="#7c3aed"/>
                                        <rect x="20" y="25" width="60" height="18" rx="8" fill="#a78bfa"/>
                                        <circle cx="35" cy="55" r="6" fill="#e0d4f7"/>
                                        <circle cx="50" cy="55" r="6" fill="#e0d4f7"/>
                                        <circle cx="65" cy="55" r="6" fill="#e0d4f7"/>
                                        <circle cx="35" cy="72" r="6" fill="#e0d4f7"/>
                                        <circle cx="50" cy="72" r="6" fill="#f59e0b"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px;">
                        <!-- Sales Chart -->
                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: bold; color: #23282d;">Sales</h3>
                                <div style="display: flex; gap: 15px; font-size: 13px;">
                                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #7c3aed; border-radius: 50%;"></span> Gold</span>
                                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #a78bfa; border-radius: 50%;"></span> Silver</span>
                                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #06b6d4; border-radius: 50%;"></span> Bronze</span>
                                </div>
                            </div>
                            <div style="height: 280px;">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>

                        <!-- Packages Donut Chart -->
                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: bold; color: #23282d;">Packages</h3>
                                <div style="display: flex; gap: 15px; font-size: 13px;">
                                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #7c3aed; border-radius: 50%;"></span> Gold</span>
                                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #a78bfa; border-radius: 50%;"></span> Silver</span>
                                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 10px; height: 10px; background: #06b6d4; border-radius: 50%;"></span> Bronze</span>
                                </div>
                            </div>
                            <div style="height: 280px; display: flex; align-items: center; justify-content: center;">
                                <canvas id="packagesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab Content -->
                <div id="dashboard-payments" class="dash-content" style="display: none;">
                    <!-- Month Tabs -->
                    <div style="display: flex; gap: 8px; margin: 20px 0; flex-wrap: wrap;">
                        <span class="month-tab active" onclick="switchPaymentMonth(1)" id="month-1" style="padding: 8px 16px; background: #7c3aed; color: white; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Jan</span>
                        <span class="month-tab" onclick="switchPaymentMonth(2)" id="month-2" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Feb</span>
                        <span class="month-tab" onclick="switchPaymentMonth(3)" id="month-3" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Mar</span>
                        <span class="month-tab" onclick="switchPaymentMonth(4)" id="month-4" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Apr</span>
                        <span class="month-tab" onclick="switchPaymentMonth(5)" id="month-5" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">May</span>
                        <span class="month-tab" onclick="switchPaymentMonth(6)" id="month-6" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Jun</span>
                        <span class="month-tab" onclick="switchPaymentMonth(7)" id="month-7" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Jul</span>
                        <span class="month-tab" onclick="switchPaymentMonth(8)" id="month-8" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Aug</span>
                        <span class="month-tab" onclick="switchPaymentMonth(9)" id="month-9" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Sep</span>
                        <span class="month-tab" onclick="switchPaymentMonth(10)" id="month-10" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Oct</span>
                        <span class="month-tab" onclick="switchPaymentMonth(11)" id="month-11" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Nov</span>
                        <span class="month-tab" onclick="switchPaymentMonth(12)" id="month-12" style="padding: 8px 16px; background: #f3f4f6; color: #666; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;">Dec</span>
                    </div>

                    <!-- Stats Summary -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <p style="color: #666; font-size: 14px; margin: 0 0 5px 0;">Total Expected</p>
                            <h2 id="payment-total" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">‚Ç¨0</h2>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <p style="color: #666; font-size: 14px; margin: 0 0 5px 0;">Paid</p>
                            <h2 id="payment-paid" style="font-size: 28px; font-weight: 600; margin: 0; color: #22c55e;">‚Ç¨0</h2>
                        </div>
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <p style="color: #666; font-size: 14px; margin: 0 0 5px 0;">Unpaid</p>
                            <h2 id="payment-unpaid" style="font-size: 28px; font-weight: 600; margin: 0; color: #ef4444;">‚Ç¨0</h2>
                        </div>
                    </div>

                    <!-- Payment List -->
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 18px; font-weight: bold; color: #23282d;">Payment Status - <span id="current-month-name">January</span> 2025</h3>
                            <select id="paymentStatusFilter" onchange="filterPayments()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                <option value="all">All</option>
                                <option value="paid">Paid</option>
                                <option value="unpaid">Unpaid</option>
                            </select>
                        </div>
                        <div id="paymentsList">
                            <!-- Payments will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Reviews Tab Content -->
                <div id="dashboard-reviews" class="dash-content" style="display: none;">
                    <!-- Stats Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0;">
                        <!-- Total Reviews Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Total Reviews</p>
                                    <h2 id="stat-total-reviews" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-total-reviews-percent" style="color: #22c55e; font-size: 13px; font-weight: 500;">100%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-total-reviews-bar" style="width: 100%; height: 100%; background: #22c55e; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <rect x="15" y="20" width="70" height="60" rx="8" fill="#7c3aed"/>
                                        <rect x="25" y="35" width="50" height="6" rx="3" fill="#e0d4f7"/>
                                        <rect x="25" y="48" width="35" height="6" rx="3" fill="#e0d4f7"/>
                                        <rect x="25" y="61" width="45" height="6" rx="3" fill="#e0d4f7"/>
                                        <circle cx="75" cy="70" r="15" fill="#f59e0b"/>
                                        <text x="75" y="76" text-anchor="middle" fill="white" font-size="16" font-weight="bold">‚òÖ</text>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Reviews Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Pending</p>
                                    <h2 id="stat-pending-reviews" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-pending-reviews-percent" style="color: #f59e0b; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-pending-reviews-bar" style="width: 0%; height: 100%; background: #f59e0b; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <circle cx="50" cy="50" r="35" fill="#f59e0b"/>
                                        <rect x="47" y="25" width="6" height="28" rx="3" fill="white"/>
                                        <rect x="47" y="45" width="6" height="18" rx="3" fill="white" transform="rotate(90 50 50)"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Published Reviews Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Published</p>
                                    <h2 id="stat-published-reviews" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-published-reviews-percent" style="color: #22c55e; font-size: 13px; font-weight: 500;">0%</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-published-reviews-bar" style="width: 0%; height: 100%; background: #22c55e; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <circle cx="50" cy="50" r="35" fill="#22c55e"/>
                                        <path d="M35 50 L45 60 L68 37" stroke="white" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Average Rating Card -->
                        <div class="stat-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <p style="color: #23282d; font-size: 18px; font-weight: bold; margin: 0 0 8px 0;">Avg Rating</p>
                                    <h2 id="stat-avg-rating" style="font-size: 28px; font-weight: 600; margin: 0; color: #23282d;">0.0</h2>
                                    <div style="margin-top: 12px;">
                                        <span id="stat-avg-rating-stars" style="color: #f59e0b; font-size: 13px; font-weight: 500;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                                        <div style="width: 80px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 6px;">
                                            <div id="stat-avg-rating-bar" style="width: 80%; height: 100%; background: #f59e0b; border-radius: 2px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 60px; height: 60px;">
                                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                        <polygon points="50,10 61,40 95,40 68,60 79,90 50,72 21,90 32,60 5,40 39,40" fill="#f59e0b"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reviews Filter & List -->
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 18px; font-weight: bold; color: #23282d;">All Reviews</h3>
                            <div style="display: flex; gap: 10px;">
                                <select id="reviewStatusFilter" onchange="filterReviews()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="all">All Reviews</option>
                                    <option value="published">Published</option>
                                    <option value="pending">Pending</option>
                                    <option value="paused">Paused</option>
                                </select>
                                <select id="reviewRatingFilter" onchange="filterReviews()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="all">All Ratings</option>
                                    <option value="5">5 Stars</option>
                                    <option value="4">4 Stars</option>
                                    <option value="3">3 Stars</option>
                                    <option value="2">2 Stars</option>
                                    <option value="1">1 Star</option>
                                </select>
                            </div>
                        </div>
                        <div id="reviewFilterResults" style="color: #666; font-size: 14px; margin-bottom: 15px; display: none;"></div>
                        <div id="reviewsList" style="max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; padding: 40px; color: #999;">Loading reviews...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- (rest of the HTML pages remain EXACTLY the same...) -->
            <!-- I'll continue from line ~800 where the JavaScript starts -->

            <!-- Add Venue Page -->
            <div id="add-venue-page" class="content-page">
                <div class="page-header">
                    <h1 id="formTitle">Add New Venue</h1>
                </div>
                <div class="panel">
                    <form id="venueForm">
                <input type="hidden" id="venueId">
                
                <!-- VENUE LOGIN CREDENTIALS (Only for new venues) -->
                <div id="venueCredentialsSection" class="credentials-section">
                    <h2>üîê Venue Login Credentials</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="venue_email">Email (for login) *</label>
                            <input type="email" id="venue_email" placeholder="venue@example.com">
                        </div>
                        <div class="form-group">
                            <label for="venue_password">Password (for login) *</label>
                            <input type="password" id="venue_password" placeholder="Minimum 6 characters">
                        </div>
                    </div>
                    <div class="credentials-note">
                        <p><strong>‚ö†Ô∏è IMPORTANT:</strong> These credentials will allow the venue to log into the mobile app and manage their deals/events. <strong>Required for new venues only.</strong> Leave blank when editing existing venues.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="name">Venue Name *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" required onchange="updateSubCategories()">
                        <option value="">Select category...</option>
                        <option value="Restaurants">Restaurants</option>
                        <option value="Sport Bars">Sport Bars</option>
                        <option value="Massage & Spa">Massage & Spa</option>
                        <option value="Healthcare & Emergency">Healthcare & Emergency</option>
                        <option value="Nightclubs">Nightclubs</option>
                        <option value="Post Offices & Banks">Post Offices & Banks</option>
                        <option value="Car & Bike Rentals">Car & Bike Rentals</option>
                        <option value="Shopping Centres">Shopping Centres</option>
                        <option value="Beaches">Beaches</option>
                    </select>
                </div>

                <!-- CUISINE CHECKBOXES -->
                <div class="form-group hidden" id="cuisineGroup">
                    <label>Cuisine (Select all that apply)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Thai">
                            <span>Thai</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Burger">
                            <span>Burger</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Chinese">
                            <span>Chinese</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="French">
                            <span>French</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Indian">
                            <span>Indian</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="International">
                            <span>International</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Mediterranean">
                            <span>Mediterranean</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Mexican">
                            <span>Mexican</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Pizza & Pasta">
                            <span>Pizza & Pasta</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Spanish">
                            <span>Spanish</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Steak">
                            <span>Steak</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="cuisine" value="Swedish">
                            <span>Swedish</span>
                        </label>
                    </div>
                </div>

                <!-- PUB TYPE CHECKBOXES -->
                <div class="form-group hidden" id="pubTypeGroup">
                    <label>Pub Type (Select all that apply)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="English Pub">
                            <span>English Pub</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Irish Pub">
                            <span>Irish Pub</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Sportbar">
                            <span>Sportbar</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Live Band">
                            <span>Live Band</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Serve Food">
                            <span>Serve Food</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="pub_types" value="Sport on TV">
                            <span>Sport on TV</span>
                        </label>
                    </div>
                </div>

                <!-- SPA TYPE CHECKBOXES -->
                <div class="form-group hidden" id="spaTypeGroup">
                    <label>Spa Type (Select all that apply)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" name="spa_types" value="Massage">
                            <span>Massage</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="spa_types" value="Spa">
                            <span>Spa</span>
                        </label>
                    </div>
                </div>

                <!-- SPORT TYPE SELECT -->
                <div class="form-group hidden" id="sportTypeGroup">
                    <label for="sport_type">Sport Type</label>
                    <select id="sport_type">
                        <option value="">Select sport type...</option>
                        <option value="Golf">Golf</option>
                        <option value="Padel">Padel</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Watersports">Watersports</option>
                    </select>
                </div>

                <!-- ATTRACTION TYPE SELECT -->
                <div class="form-group hidden" id="attractionTypeGroup">
                    <label for="attraction_type">Attraction Type</label>
                    <select id="attraction_type">
                        <option value="">Select attraction type...</option>
                        <option value="Beaches">Beaches</option>
                        <option value="Culture">Culture</option>
                        <option value="Markets">Markets</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Tours">Tours</option>
                    </select>
                </div>

                <!-- HEALTHCARE TYPE SELECT -->
                <div class="form-group hidden" id="healthcareTypeGroup">
                    <label for="healthcare_type">Healthcare Type</label>
                    <select id="healthcare_type">
                        <option value="">Select healthcare type...</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Clinic">Clinic</option>
                        <option value="Pharmacy">Pharmacy</option>
                        <option value="Dentist">Dentist</option>
                        <option value="Emergency Services">Emergency Services</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="location">Full Address *</label>
                        <input type="text" id="location" required placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="location_short">Short Location *</label>
                        <input type="text" id="location_short" required placeholder="Type here...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="text" id="phone" placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="whatsapp">WhatsApp</label>
                        <input type="text" id="whatsapp" placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="line">Line</label>
                        <input type="text" id="line" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-group">
                    <label for="website">Website</label>
                    <input type="url" id="website" placeholder="Type here...">
                </div>

                <div class="form-group">
    <label>üì± Social Media</label>
    <div class="form-row">
        <input type="url" id="facebook" placeholder="Facebook URL...">
        <input type="url" id="instagram" placeholder="Instagram URL...">
    </div>
    <div class="form-row" style="margin-top: 10px;">
        <input type="url" id="tiktok" placeholder="TikTok URL...">
        <input type="url" id="xtwitter" placeholder="X/Twitter URL...">
    </div>
</div>

                <div class="form-group">
                    <label>‚è∞ Opening Hours</label>
                    <div class="hours-row">
                        <label>Monday:</label>
                        <input type="text" id="monday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Tuesday:</label>
                        <input type="text" id="tuesday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Wednesday:</label>
                        <input type="text" id="wednesday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Thursday:</label>
                        <input type="text" id="thursday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Friday:</label>
                        <input type="text" id="friday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Saturday:</label>
                        <input type="text" id="saturday_hours" placeholder="Type here...">
                    </div>
                    <div class="hours-row">
                        <label>Sunday:</label>
                        <input type="text" id="sunday_hours" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-group">
                    <label>‚ú® Features</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_indoor">
                            <span>üè† Indoor Seating</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_outdoor">
                            <span>‚òÄÔ∏è Outdoor Seating</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_creditcard">
                            <span>üí≥ Accept Credit Cards</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_seaview">
                            <span>üåä Sea View</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_smoking">
                            <span>üö¨ Smoking Area</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="feature_wheelchair">
                            <span>‚ôø Wheelchair Accessible</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üì∏ Images (Max 6) - First image will be the main card image</label>
                    <div class="image-upload-section">
                        <input type="file" id="imageInput" accept="image/*" multiple>
                        <label for="imageInput" class="upload-btn">Choose Images</label>
                        <div class="upload-info">
                            Max 6 images ‚Ä¢ JPG, PNG, WebP ‚Ä¢ First image = Card image
                        </div>
                        <div id="imagePreview" class="image-preview-grid"></div>
                    </div>
                </div>

                <!-- Package & Payment Section -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="venuePackage">Package</label>
                        <select id="venuePackage">
                            <option value="Bronze">Bronze - ‚Ç¨99</option>
                            <option value="Silver">Silver - ‚Ç¨199</option>
                            <option value="Gold" selected>Gold - ‚Ç¨499</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="venuePaymentDate">Payment Date</label>
                        <input type="date" id="venuePaymentDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="rating">Rating (0-5)</label>
                        <input type="number" id="rating" step="0.1" min="0" max="5" placeholder="Type here...">
                    </div>
                    <div class="form-group">
                        <label for="review_count">Review Count</label>
                        <input type="number" id="review_count" placeholder="Type here...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="price_range">Price Range *</label>
                        <select id="price_range" required>
                            <option value="">Select price...</option>
                            <option value="‚Ç¨">‚Ç¨ (Budget)</option>
                            <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ (Moderate)</option>
                            <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ (Upscale)</option>
                            <option value="‚Ç¨‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Luxury)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="views">Views</label>
                        <input type="number" id="views" placeholder="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="registered_date">Registered Date</label>
                    <input type="date" id="registered_date">
                </div>

                <button type="submit" id="submitBtn">Add Venue</button>
                <button type="button" id="cancelBtn" onclick="cancelEdit()" style="display: none; background: #95a5a6;">Cancel</button>
            </form>
                </div>
            </div>

<!-- Add Deal Page -->
            <div id="add-deal-page" class="content-page">
                <div class="page-header">
                    <h1 id="dealFormTitle">Add New Deal</h1>
                </div>
                <div class="panel">
                <form id="dealForm">
                    <input type="hidden" id="dealId">
                    
                    <div class="form-group">
                        <label for="deal_name">Deal Name *</label>
                        <input type="text" id="deal_name" required>
                    </div>

                    <div class="form-group">
                        <label for="deal_category">Deal / Promotion Category *</label>
                        <select id="deal_category" required>
                            <option value="">Select category...</option>
                            <option value="Happy Hours">Happy Hours</option>
                            <option value="Watersport Deals">Watersport Deals</option>
                            <option value="Restaurant Deals">Restaurant Deals</option>
                            <option value="Sport Deals">Sport Deals</option>
                            <option value="Pub & Bar Deals">Pub & Bar Deals</option>
                            <option value="Other Deals">Other Deals</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="deal_description">Description *</label>
                        <textarea id="deal_description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="deal_phone">Phone</label>
                        <input type="text" id="deal_phone" placeholder="Type here...">
                    </div>

                    <div class="form-group">
                        <label for="deal_venue_link">Link to Venue (for contact/hours/rating) *</label>
                        <select id="deal_venue_link" required>
                            <option value="">Select venue...</option>
                            <!-- Will be populated with venues from database -->
                        </select>
                    </div>

                    <!-- Date & Time Section -->
                    <div class="form-group">
                        <label>üìÖ Deal Schedule Start Day</label>
                        
                        <div class="form-row" style="margin-top: 10px; grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label for="deal_date">Date *</label>
                                <input type="date" id="deal_date" required>
                            </div>
                            <div class="form-group">
                                <label for="deal_start_time">Start Time</label>
                                <input type="time" id="deal_start_time" value="12:00">
                            </div>
                            <div class="form-group">
                                <label for="deal_end_time">End Time</label>
                                <input type="time" id="deal_end_time" value="12:00">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="deal_repeat" onchange="toggleRepeatOptions()" style="width: auto; margin-right: 8px;">
                                <span>üîÅ Repeat (show for entire month or specific days)</span>
                            </label>
                        </div>

                        <!-- Repeat Options (hidden by default) -->
                        <div id="repeatOptions" class="form-group hidden" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <label style="margin-bottom: 10px;">Repeat on:</label>
                            
                            <!-- Grid layout: 4 columns -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                                <!-- Row 1 -->
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Monday">
                                    <span>Monday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Tuesday">
                                    <span>Tuesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Wednesday">
                                    <span>Wednesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Thursday">
                                    <span>Thursday</span>
                                </label>
                                
                                <!-- Row 2 -->
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Friday">
                                    <span>Friday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Saturday">
                                    <span>Saturday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="repeat_days" value="Sunday">
                                    <span>Sunday</span>
                                </label>
                            </div>

                            <!-- Third row: Number of weeks -->
                            <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                                <label for="repeat_weeks">Number of weeks to repeat</label>
                                <input type="number" id="repeat_weeks" min="1" max="52" placeholder="4" style="width: 150px;">
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    üìù Example: Select Friday + Saturday with 4 weeks = 8 deals total (Friday √ó 4 + Saturday √ó 4)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üì∏ Deal Image (Max 1) - Main card image</label>
                        <div class="image-upload-section">
                            <input type="file" id="dealImageInput" accept="image/*">
                            <label for="dealImageInput" class="upload-btn">Choose Image</label>
                            <div class="upload-info">
                                Max 1 image ‚Ä¢ JPG, PNG, WebP
                            </div>
                            <div id="dealImagePreview" class="image-preview-grid"></div>
                        </div>
                    </div>

                    <div class="form-row" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="deal_price">Price (e.g. ‚Ç¨15, Buy 1 Get 1, 50% off)</label>
                            <input type="text" id="deal_price" placeholder="‚Ç¨15:00">
                        </div>
                        <div class="form-group">
                            <label for="deal_views">Views</label>
                            <input type="number" id="deal_views" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="deal_registered_date">Registered Date</label>
                        <input type="date" id="deal_registered_date">
                    </div>

                    <button type="submit" id="dealSubmitBtn">Add Deal</button>
                    <button type="button" id="dealCancelBtn" onclick="cancelDealEdit()" style="display: none; background: #95a5a6;">Cancel</button>
                </form>
                </div>
            </div>

            <!-- All Venues Page -->
            <div id="all-venues-page" class="content-page">
                <div class="page-header">
                    <h1>All Venues & Services</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="venueSearch" placeholder="üîç Search by venue name..." oninput="filterVenues()">
                        </div>
                        <div class="category-filter">
                            <select id="categoryFilter" onchange="filterVenues()">
                                <option value="">All Categories</option>
                                <option value="Restaurants">Restaurants</option>
                                <option value="Sport Bars">Sport Bars</option>
                                <option value="Massage & Spa">Massage & Spa</option>
                                <option value="Healthcare & Emergency">Healthcare & Emergency</option>
                                <option value="Nightclubs">Nightclubs</option>
                                <option value="Post Offices & Banks">Post Offices & Banks</option>
                                <option value="Car & Bike Rentals">Car & Bike Rentals</option>
                                <option value="Shopping Centres">Shopping Centres</option>
                                <option value="Beaches">Beaches</option>
                            </select>
                        </div>
                        <div class="category-filter">
                            <select id="venueStatusFilter" onchange="filterVenues()">
                                <option value="all">All Venues</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="filterResults" class="filter-results" style="display: none;"></div>
                    <div id="venuesList" class="loading">Loading venues...</div>
                </div>
            </div>

            <!-- All Deals Page -->
            <div id="all-deals-page" class="content-page">
                <div class="page-header">
                    <h1>All Deals & Promotions</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="dealSearch" placeholder="üîç Search by deal name..." oninput="filterDeals()">
                        </div>
                        <div class="category-filter">
                            <select id="dealCategoryFilter" onchange="filterDeals()">
                                <option value="">All Categories</option>
                                <option value="Happy Hours">Happy Hours</option>
                                <option value="Watersport Deals">Watersport Deals</option>
                                <option value="Restaurant Deals">Restaurant Deals</option>
                                <option value="Sport Deals">Sport Deals</option>
                                <option value="Pub & Bar Deals">Pub & Bar Deals</option>
                                <option value="Other Deals">Other Deals</option>
                            </select>
                        </div>
                        <div class="category-filter">
                            <select id="dealStatusFilter" onchange="filterDeals()">
                                <option value="all">All Deals</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Old/Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="dealFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="dealsList" class="loading">Loading deals...</div>
                </div>
            </div>

            <!-- Add Event Page -->
            <div id="add-event-page" class="content-page">
                <div class="page-header">
                    <h1 id="eventFormTitle">Add New Event</h1>
                </div>
                <div class="panel">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    
                    <div class="form-group">
                        <label for="event_name">Event Name *</label>
                        <input type="text" id="event_name" required>
                    </div>

                    <div class="form-group">
                        <label for="event_category">Events / Happenings Category *</label>
                        <select id="event_category" required>
                            <option value="">Select category...</option>
                            <option value="Concerts & Festivals">Concerts & Festivals</option>
                            <option value="Sports Events">Sports Events</option>
                            <option value="Markets & Attractions">Markets & Attractions</option>
                            <option value="Tours & Trips">Tours & Trips</option>
                            <option value="Other Events">Other Events</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="event_description">Description *</label>
                        <textarea id="event_description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="event_phone">Phone</label>
                        <input type="text" id="event_phone" placeholder="Type here...">
                    </div>

                    <div class="form-group">
                        <label for="event_website">Website / Link</label>
                        <input type="url" id="event_website" placeholder="Type here...">
                    </div>

                    <div class="form-group">
                        <label>üìÖ Event Schedule Start Day</label>
                        
                        <div class="form-row" style="margin-top: 10px; grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label for="event_date">Date *</label>
                                <input type="date" id="event_date" required>
                            </div>
                            <div class="form-group">
                                <label for="event_start_time">Start Time</label>
                                <input type="time" id="event_start_time" value="20:00">
                            </div>
                            <div class="form-group">
                                <label for="event_end_time">End Time</label>
                                <input type="time" id="event_end_time" value="23:00">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="event_repeat" onchange="toggleEventRepeatOptions()" style="width: auto; margin-right: 8px;">
                                <span>üîÅ Repeat (show for entire month or specific days)</span>
                            </label>
                        </div>

                        <div id="eventRepeatOptions" class="form-group hidden" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <label style="margin-bottom: 10px;">Repeat on:</label>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Monday">
                                    <span>Monday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Tuesday">
                                    <span>Tuesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Wednesday">
                                    <span>Wednesday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Thursday">
                                    <span>Thursday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Friday">
                                    <span>Friday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Saturday">
                                    <span>Saturday</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="event_repeat_days" value="Sunday">
                                    <span>Sunday</span>
                                </label>
                            </div>

                            <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                                <label for="event_repeat_weeks">Number of weeks to repeat</label>
                                <input type="number" id="event_repeat_weeks" min="1" max="52" placeholder="4" style="width: 150px;">
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    üìù Example: Select Friday + Saturday with 4 weeks = 8 events total
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üì∏ Event Image (Max 1) - Main card image</label>
                        <div class="image-upload-section">
                            <input type="file" id="eventImageInput" accept="image/*">
                            <label for="eventImageInput" class="upload-btn">Choose Image</label>
                            <div class="upload-info">
                                Max 1 image ‚Ä¢ JPG, PNG, WebP
                            </div>
                            <div id="eventImagePreview" class="image-preview-grid"></div>
                        </div>
                    </div>

                    <div class="form-row" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="event_price">Price (e.g. ‚Ç¨15, Free Entry)</label>
                            <input type="text" id="event_price" placeholder="Free">
                        </div>
                        <div class="form-group">
                            <label for="event_views">Views</label>
                            <input type="number" id="event_views" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="event_registered_date">Registered Date</label>
                        <input type="date" id="event_registered_date">
                    </div>

                    <button type="submit" id="eventSubmitBtn">Add Event</button>
                    <button type="button" id="eventCancelBtn" onclick="cancelEventEdit()" style="display: none; background: #95a5a6;">Cancel</button>
                </form>
                </div>
            </div>

            <!-- All Events Page -->
            <div id="all-events-page" class="content-page">
                <div class="page-header">
                    <h1>All Events</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="eventSearch" placeholder="üîç Search by event name..." oninput="filterEvents()">
                        </div>
                        <div class="category-filter">
                            <select id="eventCategoryFilter" onchange="filterEvents()">
                                <option value="">All Categories</option>
                                <option value="Concerts & Festivals">Concerts & Festivals</option>
                                <option value="Sports Events">Sports Events</option>
                                <option value="Markets & Attractions">Markets & Attractions</option>
                                <option value="Tours & Trips">Tours & Trips</option>
                                <option value="Other Events">Other Events</option>
                            </select>
                        </div>
                        <div class="category-filter">
                            <select id="eventStatusFilter" onchange="filterEvents()">
                                <option value="all">All Events</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Old/Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="eventFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="eventsList" class="loading">Loading events...</div>
                </div>
            </div>

            <!-- Visitors Page -->
            <div id="visitors-page" class="content-page">
                <div class="page-header">
                    <h1>üë• Visitors (App Users)</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="visitorSearch" placeholder="üîç Search by name or email..." oninput="filterVisitors()">
                        </div>
                    </div>
                    <div id="visitorFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="visitorsList" class="loading">Loading visitors...</div>
                </div>
            </div>

            <!-- Customers (Venues) Page -->
            <div id="customers-page" class="content-page">
                <div class="page-header">
                    <h1>üè™ Customers (Venue Users)</h1>
                </div>
                <div class="panel">
                    <div class="venue-filters">
                        <div class="search-box">
                            <input type="text" id="customerSearch" placeholder="üîç Search by venue name or email..." oninput="filterCustomers()">
                        </div>
                        <div class="category-filter">
                            <select id="customerStatusFilter" onchange="filterCustomers()">
                                <option value="all">All Customers</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div id="customerFilterResults" class="filter-results" style="display: none;"></div>
                    <div id="customersList" class="loading">Loading customers...</div>
                </div>
            </div>

            <!-- Packages Page -->
            <div id="packages-page" class="content-page">
                <div class="page-header">
                    <h1>üì¶ Subscription Packages</h1>
                </div>
                <p style="color: #666; margin-bottom: 30px;">Configure what each package includes. This information is shown to venue owners in the mobile app.</p>
                
                <!-- Bronze Package -->
                <div class="panel" style="border-left: 4px solid #cd7f32;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="border: none; padding: 0; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <span style="background: #cd7f32; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;">Bronze</span>
                                Package
                            </h2>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #cd7f32;">‚Ç¨99<span style="font-size: 14px; color: #999;">/year</span></div>
                    </div>
                    <div class="form-group">
                        <label>Package Benefits (one per line)</label>
                        <textarea id="bronzePackageBenefits" rows="6" placeholder="Enter benefits, one per line..." style="font-size: 14px;">Basic venue listing
Up to 3 photos
Contact information display
Opening hours display</textarea>
                    </div>
                    <button onclick="savePackageBenefits('Bronze')" style="background: #cd7f32;">üíæ Save Bronze Package</button>
                </div>

                <!-- Silver Package -->
                <div class="panel" style="border-left: 4px solid #9ca3af;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="border: none; padding: 0; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <span style="background: #9ca3af; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;">Silver</span>
                                Package
                            </h2>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #9ca3af;">‚Ç¨199<span style="font-size: 14px; color: #999;">/year</span></div>
                    </div>
                    <div class="form-group">
                        <label>Package Benefits (one per line)</label>
                        <textarea id="silverPackageBenefits" rows="6" placeholder="Enter benefits, one per line..." style="font-size: 14px;">Enhanced venue listing
Up to 6 photos
Contact information display
Opening hours display
Create deals & promotions
50 credits per month</textarea>
                    </div>
                    <button onclick="savePackageBenefits('Silver')" style="background: #9ca3af;">üíæ Save Silver Package</button>
                </div>

                <!-- Gold Package -->
                <div class="panel" style="border-left: 4px solid #f59e0b;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="border: none; padding: 0; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <span style="background: #f59e0b; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px;">Gold</span>
                                Package
                            </h2>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">‚Ç¨499<span style="font-size: 14px; color: #999;">/year</span></div>
                    </div>
                    <div class="form-group">
                        <label>Package Benefits (one per line)</label>
                        <textarea id="goldPackageBenefits" rows="8" placeholder="Enter benefits, one per line..." style="font-size: 14px;">Premium venue listing
Unlimited photos
Featured listing placement
Contact information display
Opening hours display
Create deals & promotions
Create events
100 credits per month
Priority support</textarea>
                    </div>
                    <button onclick="savePackageBenefits('Gold')" style="background: #f59e0b;">üíæ Save Gold Package</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Page switching for sidebar menu
        function switchPage(pageName) {
            const pages = document.querySelectorAll('.content-page');
            pages.forEach(page => page.classList.remove('active'));
            
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            
            const targetPage = document.getElementById(pageName + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            if (pageName === 'dashboard') {
                updateDashboardPeriod();
            } else if (pageName === 'all-venues') {
                loadVenues();
            } else if (pageName === 'all-deals') {
                loadDeals();
            } else if (pageName === 'all-events') {
                loadEvents();
            } else if (pageName === 'visitors') {
                loadVisitors();
            } else if (pageName === 'customers') {
                loadCustomers();
            } else if (pageName === 'packages') {
                loadPackages();
            }
        }

        const SUPABASE_URL = 'https://vfponburmjbuqqneigjr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmcG9uYnVybWpidXFxbmVpZ2pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTUwODgsImV4cCI6MjA4MDk5MTA4OH0.4osS6AQ6tUaRpoO8dtwlBBOsbnNymzFR7SB2aWVj7DM';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let editingVenue = null;
        let uploadedImages = [];
        let editingDeal = null;
        let uploadedDealImage = null;
        let allVenues = [];
        let allDeals = [];
        let allVisitors = [];
        let allCustomers = [];
        
        // MODAL VARIABLES
        let currentEditingVisitorId = null;
        let currentEditingCustomerId = null;

        function updateSubCategories() {
            const category = document.getElementById('category').value;
            
            document.getElementById('cuisineGroup').classList.add('hidden');
            document.getElementById('pubTypeGroup').classList.add('hidden');
            document.getElementById('spaTypeGroup').classList.add('hidden');
            document.getElementById('sportTypeGroup').classList.add('hidden');
            document.getElementById('attractionTypeGroup').classList.add('hidden');
            document.getElementById('healthcareTypeGroup').classList.add('hidden');
            
            if (category === 'Restaurants') {
                document.getElementById('cuisineGroup').classList.remove('hidden');
            } else if (category === 'Sport Bars') {
                document.getElementById('pubTypeGroup').classList.remove('hidden');
            } else if (category === 'Massage & Spa') {
                document.getElementById('spaTypeGroup').classList.remove('hidden');
            } else if (category === 'Sports Activities') {
                document.getElementById('sportTypeGroup').classList.remove('hidden');
            } else if (category === 'Markets & Attractions') {
                document.getElementById('attractionTypeGroup').classList.remove('hidden');
            } else if (category === 'Healthcare & Emergency') {
                document.getElementById('healthcareTypeGroup').classList.remove('hidden');
            }
        }

        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            
            const venueRegisteredDate = document.getElementById('registered_date');
            if (venueRegisteredDate) {
                venueRegisteredDate.value = today;
            }
            
            const dealRegisteredDate = document.getElementById('deal_registered_date');
            if (dealRegisteredDate) {
                dealRegisteredDate.value = today;
            }
            
            const eventRegisteredDate = document.getElementById('event_registered_date');
            if (eventRegisteredDate) {
                eventRegisteredDate.value = today;
            }
        });

        document.addEventListener('DOMContentLoaded', () => { 
            loadVenues();
            loadVenuesForDealDropdown();
        });

document.getElementById('imageInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (uploadedImages.length + files.length > 6) {
                showError('Maximum 6 images allowed!');
                return;
            }

            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                await uploadImage(file);
            }
            renderImagePreviews();
        });

        document.getElementById('dealImageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }

            await uploadDealImage(file);
        });

        async function uploadImage(file) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = fileName;

                const { data, error } = await supabaseClient.storage
                    .from('venue-images')
                    .upload(filePath, file);

                if (error) throw error;

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('venue-images')
                    .getPublicUrl(filePath);

                uploadedImages.push(publicUrl);
                showSuccess('Image uploaded!');
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreview');
            container.innerHTML = uploadedImages.map((url, index) => `
                <div class="image-preview-item ${index === 0 ? 'main-image' : ''}">
                    <img src="${url}" alt="Preview ${index + 1}">
                    ${index === 0 ? '<div class="main-badge">MAIN</div>' : ''}
                    <button type="button" class="remove-image" onclick="removeImage(${index})">√ó</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderImagePreviews();
        }

        async function uploadDealImage(file) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `deal-${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = fileName;

                const { data, error } = await supabaseClient.storage
                    .from('venue-images')
                    .upload(filePath, file);

                if (error) throw error;

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('venue-images')
                    .getPublicUrl(filePath);

                uploadedDealImage = publicUrl;
                renderDealImagePreview();
                showSuccess('Image uploaded!');
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        function renderDealImagePreview() {
            const container = document.getElementById('dealImagePreview');
            if (!uploadedDealImage) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `
                <div class="image-preview-item main-image">
                    <img src="${uploadedDealImage}" alt="Deal image">
                    <div class="main-badge">MAIN</div>
                    <button type="button" class="remove-image" onclick="removeDealImage()">√ó</button>
                </div>
            `;
        }

        function removeDealImage() {
            uploadedDealImage = null;
            renderDealImagePreview();
            document.getElementById('dealImageInput').value = '';
        }

        document.getElementById('venueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const openingHours = {
                monday: document.getElementById('monday_hours').value,
                tuesday: document.getElementById('tuesday_hours').value,
                wednesday: document.getElementById('wednesday_hours').value,
                thursday: document.getElementById('thursday_hours').value,
                friday: document.getElementById('friday_hours').value,
                saturday: document.getElementById('saturday_hours').value,
                sunday: document.getElementById('sunday_hours').value
            };
            
            const features = [];
            if (document.getElementById('feature_indoor').checked) features.push('Indoor Seating');
            if (document.getElementById('feature_outdoor').checked) features.push('Outdoor Seating');
            if (document.getElementById('feature_creditcard').checked) features.push('Accept Credit Cards');
            if (document.getElementById('feature_seaview').checked) features.push('Sea View');
            if (document.getElementById('feature_smoking').checked) features.push('Smoking Area');
            if (document.getElementById('feature_wheelchair').checked) features.push('Wheelchair Accessible');
            
            const cuisineCheckboxes = document.querySelectorAll('input[name="cuisine"]:checked');
            const selectedCuisines = Array.from(cuisineCheckboxes).map(cb => cb.value);
            
            const pubTypeCheckboxes = document.querySelectorAll('input[name="pub_types"]:checked');
            const selectedPubTypes = Array.from(pubTypeCheckboxes).map(cb => cb.value);
            
            const spaTypeCheckboxes = document.querySelectorAll('input[name="spa_types"]:checked');
            const selectedSpaTypes = Array.from(spaTypeCheckboxes).map(cb => cb.value);
            
            const venueData = {
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                cuisine: selectedCuisines.length > 0 && document.getElementById('category').value === 'Restaurants' ? selectedCuisines : null,
                pub_types: selectedPubTypes.length > 0 && document.getElementById('category').value === 'Sport Bars' ? selectedPubTypes : null,
                spa_types: selectedSpaTypes.length > 0 && document.getElementById('category').value === 'Massage & Spa' ? selectedSpaTypes : null,
                sport_types: document.getElementById('sport_type').value && document.getElementById('category').value === 'Sports Activities' ? [document.getElementById('sport_type').value] : null,
                attraction_types: document.getElementById('attraction_type').value && document.getElementById('category').value === 'Markets & Attractions' ? [document.getElementById('attraction_type').value] : null,
                healthcare_type: document.getElementById('healthcare_type').value && document.getElementById('category').value === 'Healthcare & Emergency' ? document.getElementById('healthcare_type').value : null,
                description: document.getElementById('description').value,
                location: document.getElementById('location').value,
                location_short: document.getElementById('location_short').value,
                rating: parseFloat(document.getElementById('rating').value) || 0,
                review_count: parseInt(document.getElementById('review_count').value) || 0,
                price_range: document.getElementById('price_range').value,
                views: parseInt(document.getElementById('views').value) || 0,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                whatsapp: document.getElementById('whatsapp').value,
                line: document.getElementById('line').value,
                website: document.getElementById('website').value,
                facebook: document.getElementById('facebook').value,
                instagram: document.getElementById('instagram').value,
                tiktok: document.getElementById('tiktok').value,
                'x/twitter': document.getElementById('xtwitter').value,
                opening_hours: openingHours,
                features: features,
                registered_date: document.getElementById('registered_date').value || null,
                images: uploadedImages,
                active: true,
                package: document.getElementById('venuePackage').value,
                payment_date: document.getElementById('venuePaymentDate').value || null
            };

            try {
                let venueId = editingVenue;
                
                if (editingVenue) {
                    // EDITING EXISTING VENUE
                    // First, update the venue data
                    const { error: updateError } = await supabaseClient.from('venues').update(venueData).eq('id', editingVenue);
                    if (updateError) throw updateError;
                    
                    // Check if venue has owner_user_id (auth user)
                    const { data: venueCheck } = await supabaseClient.from('venues').select('owner_user_id').eq('id', editingVenue).single();
                    
                    // If no owner_user_id AND email/password provided, create auth user
                    if (!venueCheck.owner_user_id) {
                        const venueEmail = document.getElementById('venue_email').value;
                        const venuePassword = document.getElementById('venue_password').value;
                        
                        if (venueEmail && venuePassword) {
                            if (venuePassword.length < 6) {
                                showError('Password must be at least 6 characters!');
                                return;
                            }
                            
                            try {
                                const response = await fetch('https://vfponburmjbuqqneigjr.supabase.co/functions/v1/create-venue-user', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                    },
                                    body: JSON.stringify({
                                        email: venueEmail,
                                        password: venuePassword,
                                        venueId: editingVenue
                                    })
                                });
                                
                                const result = await response.json();
                                
                                if (!response.ok || result.error) {
                                    throw new Error(result.error || 'Failed to create venue user');
                                }
                                
                                showSuccess(`‚úÖ Venue updated and login created! Email: ${venueEmail}`);
                            } catch (edgeFunctionError) {
                                showError(`Venue updated but login creation failed: ${edgeFunctionError.message}`);
                                return;
                            }
                        } else {
                            showSuccess('Venue updated!');
                        }
                    } else {
                        showSuccess('Venue updated!');
                    }
                } else {
                    // CREATING NEW VENUE
                    const venueEmail = document.getElementById('venue_email').value;
                    const venuePassword = document.getElementById('venue_password').value;
                    
                    if (!venueEmail || !venuePassword) {
                        showError('Email and Password are required for new venues!');
                        return;
                    }
                    
                    if (venuePassword.length < 6) {
                        showError('Password must be at least 6 characters!');
                        return;
                    }
                    
                    const { data: newVenue, error: venueError } = await supabaseClient
                        .from('venues')
                        .insert([venueData])
                        .select()
                        .single();
                    
                    if (venueError) throw venueError;
                    venueId = newVenue.id;
                    
                    // Step 2: Call Edge Function to create auth user + link profile
                    try {
                        const response = await fetch('https://vfponburmjbuqqneigjr.supabase.co/functions/v1/create-venue-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                email: venueEmail,
                                password: venuePassword,
                                venueId: venueId
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok || result.error) {
                            throw new Error(result.error || 'Failed to create venue user');
                        }
                        
                        showSuccess(`‚úÖ Venue created successfully! The venue can now log in with email: ${venueEmail}`);
                    } catch (edgeFunctionError) {
                        // Edge function failed - rollback venue creation
                        await supabaseClient.from('venues').delete().eq('id', venueId);
                        throw new Error(`Failed to create venue user: ${edgeFunctionError.message}`);
                    }
                }
                
                document.getElementById('venueForm').reset();
                document.getElementById('venue_email').value = '';
                document.getElementById('venue_password').value = '';
                uploadedImages = [];
                renderImagePreviews();
                cancelEdit();
                loadVenues();
                
                switchPage('all-venues');
            } catch (error) {
                showError('Error: ' + error.message);
            }
        });

        async function loadVenues() {
            const listDiv = document.getElementById('venuesList');
            listDiv.innerHTML = '<div class="loading">Loading...</div>';
            try {
                const { data, error } = await supabaseClient.from('venues').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                
                allVenues = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No venues yet!</p>';
                    return;
                }
                
                renderVenues(data);
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function renderVenues(venues) {
            const listDiv = document.getElementById('venuesList');
            
            if (venues.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No venues match your search.</p>';
                return;
            }
            
            listDiv.innerHTML = venues.map(v => `
                    <div class="venue-item">
                        <div class="status-indicator ${v.active !== false ? 'status-active' : 'status-inactive'}" title="${v.active !== false ? 'Active' : 'Inactive'}"></div>
                        <div class="venue-info">
                            <h3>${v.name}</h3>
                            <p><strong>Category:</strong> ${v.category || 'N/A'}</p>
                            ${v.cuisine && v.cuisine.length > 0 ? `<p><strong>Cuisine:</strong> ${Array.isArray(v.cuisine) ? v.cuisine.join(', ') : v.cuisine}</p>` : ''}
                            ${v.pub_types && v.pub_types.length > 0 ? `<p><strong>Pub Types:</strong> ${Array.isArray(v.pub_types) ? v.pub_types.join(', ') : v.pub_types}</p>` : ''}
                            ${v.spa_types && v.spa_types.length > 0 ? `<p><strong>Spa Types:</strong> ${Array.isArray(v.spa_types) ? v.spa_types.join(', ') : v.spa_types}</p>` : ''}
                            ${v.sport_types && v.sport_types.length > 0 ? `<p><strong>Sport Types:</strong> ${Array.isArray(v.sport_types) ? v.sport_types.join(', ') : v.sport_types}</p>` : ''}
                            ${v.attraction_types && v.attraction_types.length > 0 ? `<p><strong>Attraction Types:</strong> ${Array.isArray(v.attraction_types) ? v.attraction_types.join(', ') : v.attraction_types}</p>` : ''}
                            ${v.healthcare_type ? `<p><strong>Healthcare Type:</strong> ${v.healthcare_type}</p>` : ''}
                            <p><strong>Location:</strong> ${v.location_short || v.location}</p>
                            <p><strong>Price:</strong> ${v.price_range} | <strong>Rating:</strong> ${v.rating || 0} ‚≠ê</p>
                            ${v.images && v.images.length > 0 ? `<p><strong>Images:</strong> ${v.images.length} üì∏</p>` : ''}
                        </div>
                        <div class="venue-actions">
                            ${v.active !== false ? 
                                `<button class="reactivate" onclick="pauseVenue(${v.id}, '${v.name.replace(/'/g, "\\'")}')">‚è∏Ô∏è Pause</button>` : 
                                `<button class="reactivate" onclick="unpauseVenue(${v.id}, '${v.name.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è Unpause</button>`
                            }
                            <button class="edit" onclick="editVenue(${v.id})">Edit</button>
                            <button class="delete" onclick="deleteVenue(${v.id}, '${v.name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function filterVenues() {
            const searchTerm = document.getElementById('venueSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('venueStatusFilter').value;
            
            let filtered = allVenues;
            
            if (searchTerm) {
                filtered = filtered.filter(v => v.name.toLowerCase().includes(searchTerm));
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(v => v.category === categoryFilter);
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(v => v.active !== false);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(v => v.active === false);
            }
            
            const resultsDiv = document.getElementById('filterResults');
            if (searchTerm || categoryFilter || statusFilter !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allVenues.length} venues`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderVenues(filtered);
        }

        async function editVenue(id) {
            try {
                const { data, error } = await supabaseClient.from('venues').select('*').eq('id', id).single();
                if (error) throw error;
                
                editingVenue = id;
                document.getElementById('formTitle').textContent = 'Edit Venue';
                document.getElementById('submitBtn').textContent = 'Update Venue';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                
                document.getElementById('venueCredentialsSection').style.display = 'block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-venue-page').classList.add('active');
                
                document.getElementById('name').value = data.name || '';
                document.getElementById('category').value = data.category || '';
                updateSubCategories();
                
                let cuisineArray = [];
                if (data.cuisine) {
                    if (Array.isArray(data.cuisine)) {
                        cuisineArray = data.cuisine;
                    } else if (typeof data.cuisine === 'string') {
                        try {
                            cuisineArray = JSON.parse(data.cuisine);
                        } catch (e) {
                            cuisineArray = [data.cuisine];
                        }
                    }
                }
                document.querySelectorAll('input[name="cuisine"]').forEach(checkbox => {
                    checkbox.checked = cuisineArray.includes(checkbox.value);
                });
                
                let pubTypesArray = [];
                if (data.pub_types) {
                    if (Array.isArray(data.pub_types)) {
                        pubTypesArray = data.pub_types;
                    } else if (typeof data.pub_types === 'string') {
                        try {
                            pubTypesArray = JSON.parse(data.pub_types);
                        } catch (e) {
                            pubTypesArray = [data.pub_types];
                        }
                    }
                }
                document.querySelectorAll('input[name="pub_types"]').forEach(checkbox => {
                    checkbox.checked = pubTypesArray.includes(checkbox.value);
                });
                
                let spaTypesArray = [];
                if (data.spa_types) {
                    if (Array.isArray(data.spa_types)) {
                        spaTypesArray = data.spa_types;
                    } else if (typeof data.spa_types === 'string') {
                        try {
                            spaTypesArray = JSON.parse(data.spa_types);
                        } catch (e) {
                            spaTypesArray = [data.spa_types];
                        }
                    }
                }
                document.querySelectorAll('input[name="spa_types"]').forEach(checkbox => {
                    checkbox.checked = spaTypesArray.includes(checkbox.value);
                });
                
                document.getElementById('sport_type').value = (data.sport_types && data.sport_types[0]) || '';
                document.getElementById('attraction_type').value = (data.attraction_types && data.attraction_types[0]) || '';
                document.getElementById('healthcare_type').value = data.healthcare_type || '';
                
                document.getElementById('description').value = data.description || '';
                document.getElementById('location').value = data.location || '';
                document.getElementById('location_short').value = data.location_short || '';
                document.getElementById('rating').value = data.rating || '';
                document.getElementById('review_count').value = data.review_count || '';
                document.getElementById('price_range').value = data.price_range || '';
                document.getElementById('views').value = data.views || '';
                document.getElementById('phone').value = data.phone || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('whatsapp').value = data.whatsapp || '';
                document.getElementById('line').value = data.line || '';
                document.getElementById('website').value = data.website || '';
                document.getElementById('facebook').value = data.facebook || '';
                document.getElementById('instagram').value = data.instagram || '';
                document.getElementById('tiktok').value = data.tiktok || '';
                document.getElementById('xtwitter').value = data['x/twitter'] || '';
                
                if (data.opening_hours) {
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    days.forEach(day => {
                        if (data.opening_hours[day]) {
                            document.getElementById(`${day}_hours`).value = data.opening_hours[day] || '';
                        }
                    });
                }
                
                document.getElementById('registered_date').value = data.registered_date || '';
                document.getElementById('venuePackage').value = data.package || 'Gold';
                document.getElementById('venuePaymentDate').value = data.payment_date || '';
                
                document.getElementById('feature_indoor').checked = data.features && data.features.includes('Indoor Seating');
                document.getElementById('feature_outdoor').checked = data.features && data.features.includes('Outdoor Seating');
                document.getElementById('feature_creditcard').checked = data.features && data.features.includes('Accept Credit Cards');
                document.getElementById('feature_seaview').checked = data.features && data.features.includes('Sea View');
                document.getElementById('feature_smoking').checked = data.features && data.features.includes('Smoking Area');
                document.getElementById('feature_wheelchair').checked = data.features && data.features.includes('Wheelchair Accessible');
                
                uploadedImages = data.images || [];
                renderImagePreviews();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function cancelEdit() {
            editingVenue = null;
            document.getElementById('formTitle').textContent = 'Add New Venue';
            document.getElementById('submitBtn').textContent = 'Add Venue';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('venueForm').reset();
            
            document.getElementById('venueCredentialsSection').style.display = 'block';
            document.getElementById('venue_email').value = '';
            document.getElementById('venue_password').value = '';
            
            document.querySelectorAll('input[name="cuisine"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="pub_types"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="spa_types"]').forEach(cb => cb.checked = false);
            
            document.getElementById('venuePackage').value = 'Gold';
            document.getElementById('venuePaymentDate').value = '';
            
            uploadedImages = [];
            renderImagePreviews();
            updateSubCategories();
        }

        async function deleteVenue(id, name) {
    if (!confirm(`Delete "${name}"?`)) return;
    try {
        // First delete from profiles if exists
        await supabaseClient.from('profiles').delete().eq('venue_id', id);
        
        // Then delete venue
        const { error } = await supabaseClient.from('venues').delete().eq('id', id);
        if (error) throw error;
        showSuccess('Deleted!');
        loadVenues();
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

        async function pauseVenue(id, name) {
            if (!confirm(`Pause "${name}"? It will be hidden from the app.`)) return;
            try {
                const { error } = await supabaseClient.from('venues').update({ active: false }).eq('id', id);
                if (error) throw error;
                showSuccess('Venue paused!');
                loadVenues();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function unpauseVenue(id, name) {
            if (!confirm(`Unpause "${name}"? It will be visible in the app again.`)) return;
            try {
                const { error } = await supabaseClient.from('venues').update({ active: true }).eq('id', id);
                if (error) throw error;
                showSuccess('Venue unpaused!');
                loadVenues();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function showSuccess(msg) {
            const div = document.getElementById('successMessage');
            div.textContent = msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 8000);
        }

        function showError(msg) {
            const div = document.getElementById('errorMessage');
            div.textContent = msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 8000);
        }

        function toggleRepeatOptions() {
            const checkbox = document.getElementById('deal_repeat');
            const repeatOptions = document.getElementById('repeatOptions');
            
            if (checkbox.checked) {
                repeatOptions.classList.remove('hidden');
            } else {
                repeatOptions.classList.add('hidden');
            }
        }

        function cancelDealEdit() {
            document.getElementById('dealForm').reset();
            document.getElementById('dealFormTitle').textContent = 'Add New Deal';
            document.getElementById('dealSubmitBtn').textContent = 'Add Deal';
            document.getElementById('dealCancelBtn').style.display = 'none';
            uploadedDealImage = null;
            renderDealImagePreview();
        }

document.getElementById('dealForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dealName = document.getElementById('deal_name').value;
const dealCategory = document.getElementById('deal_category').value;
const dealDescription = document.getElementById('deal_description').value;
const dealPhone = document.getElementById('deal_phone').value;
const venueId = document.getElementById('deal_venue_link').value;
const dealDate = document.getElementById('deal_date').value;
const startTime = document.getElementById('deal_start_time').value;
const endTime = document.getElementById('deal_end_time').value;
const isRepeat = document.getElementById('deal_repeat').checked;
const dealPrice = document.getElementById('deal_price').value;
const dealViews = parseInt(document.getElementById('deal_views').value) || 0;
const registeredDate = document.getElementById('deal_registered_date').value || null;

try {
    const repeatDaysCheckboxes = document.querySelectorAll('input[name="repeat_days"]:checked');
    const repeatDays = Array.from(repeatDaysCheckboxes).map(cb => cb.value);
    const repeatWeeks = parseInt(document.getElementById('repeat_weeks').value) || 0;

    // Calculate end_date based on repeat settings
    let calculatedEndDate;
    if (isRepeat && repeatWeeks > 0) {
        // Recurring: end_date = deal_date + (recurring_weeks * 7 days)
        const startDate = new Date(dealDate);
        calculatedEndDate = new Date(startDate);
        calculatedEndDate.setDate(calculatedEndDate.getDate() + (repeatWeeks * 7));
        calculatedEndDate = calculatedEndDate.toISOString().split('T')[0];
    } else {
        // Non-recurring: end_date = same as deal_date
        calculatedEndDate = dealDate;
    }

    const dealData = {
        name: dealName,
        category: dealCategory,
        description: dealDescription,
        phone: dealPhone,
        venue_id: parseInt(venueId),
        deal_date: dealDate,
        end_date: calculatedEndDate,
        start_time: startTime || null,
        end_time: endTime || null,
        is_recurring: isRepeat,
        recurring_day: (isRepeat && repeatDays.length > 0) ? repeatDays.join(',') : null,
        recurring_weeks: (isRepeat && repeatWeeks > 0) ? repeatWeeks : null,
        price: dealPrice,
        image_url: uploadedDealImage,
        views: dealViews,
        registered_date: registeredDate,
        active: true
    };

                if (editingDeal) {
                    const { error } = await supabaseClient.from('deals').update(dealData).eq('id', editingDeal);
                    if (error) throw error;
                    showSuccess('Deal updated successfully!');
                    
                    editingDeal = null;
                    document.getElementById('dealFormTitle').textContent = 'Add New Deal';
                    document.getElementById('dealSubmitBtn').textContent = 'Add Deal';
                    document.getElementById('dealCancelBtn').style.display = 'none';
                } else {
                    const { error } = await supabaseClient.from('deals').insert([dealData]);
                    if (error) throw error;
                    showSuccess('Deal created successfully!');
                }
                
                editingDeal = null;
                document.getElementById('dealForm').reset();
                uploadedDealImage = null;
                renderDealImagePreview();
                document.getElementById('dealFormTitle').textContent = 'Add New Deal';
                document.getElementById('dealSubmitBtn').textContent = 'Add Deal';
                document.getElementById('dealCancelBtn').style.display = 'none';
                loadDeals();
                
                switchPage('all-deals');
            } catch (error) {
                showError('Error creating deal: ' + error.message);
            }
        });

        function getNextDayOfWeek(baseDate, dayName, weekOffset) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const targetDay = days.indexOf(dayName);
            const date = new Date(baseDate);
            
            const currentDay = date.getDay();
            let daysUntilTarget = targetDay - currentDay;
            if (daysUntilTarget < 0) daysUntilTarget += 7;
            
            date.setDate(date.getDate() + daysUntilTarget + (weekOffset * 7));
            return date;
        }

        async function loadDeals() {
            const listDiv = document.getElementById('dealsList');
            listDiv.innerHTML = '<div class="loading">Loading deals...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('deals')
                    .select(`
                        *,
                        venues!deals_venue_id_fkey(name, location_short)
                    `)
                    .order('deal_date', { ascending: false });
                    
                if (error) throw error;
                
                allDeals = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No deals yet! Create your first deal using the form above.</p>';
                    return;
                }
                
                renderDeals(data);
            } catch (error) {
                showError('Error loading deals: ' + error.message);
                listDiv.innerHTML = '<p style="text-align:center;color:#e74c3c;">Error loading deals. Check console for details.</p>';
            }
        }

        function renderDeals(deals) {
            const listDiv = document.getElementById('dealsList');
            
            if (deals.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No deals match your filters.</p>';
                return;
            }
            
            listDiv.innerHTML = deals.map(deal => `
                    <div class="venue-item">
                        <div class="status-indicator ${deal.active ? 'status-active' : 'status-inactive'}" title="${deal.active ? 'Active' : 'Inactive'}"></div>
                        <div class="venue-info">
                            <h3>${deal.name}</h3>
                            <p><strong>Category:</strong> ${deal.category || 'N/A'}</p>
                            <p><strong>Venue:</strong> ${deal.venues?.name || 'N/A'} - ${deal.venues?.location_short || ''}</p>
                            <p><strong>Date:</strong> ${deal.deal_date} ${deal.start_time ? `(${deal.start_time.slice(0,5)} - ${deal.end_time.slice(0,5)})` : ''}</p>
                            ${deal.end_date ? `<p><strong>End Date:</strong> ${deal.end_date}</p>` : ''}
                            ${deal.is_recurring ? `<p><strong>Recurring:</strong> ${deal.recurring_day} (${deal.recurring_weeks} weeks)</p>` : ''}
                            <p><strong>Price:</strong> ${deal.price || 'N/A'} | <strong>Status:</strong> ${deal.active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                            ${deal.image_url ? '<p><strong>Image:</strong> üì∏</p>' : ''}
                        </div>
                        <div class="venue-actions">
                            ${!deal.active ? `<button class="reactivate" onclick="reactivateDeal(${deal.id})">üîÑ Reactivate</button>` : ''}
                            ${deal.active ? 
                                `<button class="reactivate" onclick="pauseDeal(${deal.id}, '${deal.name.replace(/'/g, "\\'")}')">‚è∏Ô∏è Pause</button>` : 
                                `<button class="reactivate" onclick="unpauseDeal(${deal.id}, '${deal.name.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è Unpause</button>`
                            }
                            <button class="edit" onclick="editDeal(${deal.id})">Edit</button>
                            <button class="delete" onclick="deleteDeal(${deal.id}, '${deal.name.replace(/'/g, "\\'")}')" >Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function filterDeals() {
            const searchTerm = document.getElementById('dealSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('dealCategoryFilter').value;
            const statusFilter = document.getElementById('dealStatusFilter').value;
            
            let filtered = allDeals;
            
            if (searchTerm) {
                filtered = filtered.filter(d => d.name.toLowerCase().includes(searchTerm));
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(d => d.category === categoryFilter);
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(d => d.active === true);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(d => d.active === false);
            }
            
            const resultsDiv = document.getElementById('dealFilterResults');
            if (searchTerm || categoryFilter || statusFilter !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allDeals.length} deals`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderDeals(filtered);
        }

        async function reactivateDeal(id) {
            try {
                const { data, error } = await supabaseClient.from('deals').select('*').eq('id', id).single();
                if (error) throw error;
                
                editingDeal = id;
                document.getElementById('dealFormTitle').textContent = 'Reactivate Deal - Set New Date';
                document.getElementById('dealSubmitBtn').textContent = 'Reactivate Deal';
                document.getElementById('dealCancelBtn').style.display = 'inline-block';
                
                switchPage('add-deal');
                
                document.getElementById('deal_name').value = data.name || '';
                document.getElementById('deal_category').value = data.category || '';
                document.getElementById('deal_description').value = data.description || '';
                document.getElementById('deal_phone').value = data.phone || '';
                document.getElementById('deal_venue_link').value = data.venue_id || '';
                document.getElementById('deal_date').value = '';
                document.getElementById('deal_start_time').value = data.start_time || '12:00';
                document.getElementById('deal_end_time').value = data.end_time || '12:00';
                document.getElementById('deal_price').value = data.price || '';
                document.getElementById('deal_views').value = 0;
                
                document.getElementById('deal_registered_date').value = new Date().toISOString().split('T')[0];
                
                uploadedDealImage = data.image_url || null;
                renderDealImagePreview();
                
                if (data.is_recurring) {
                    document.getElementById('deal_repeat').checked = true;
                    toggleRepeatOptions();
                    
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    
                    if (data.recurring_weeks) {
                        document.getElementById('repeat_weeks').value = data.recurring_weeks;
                    }
                } else {
                    document.getElementById('deal_repeat').checked = false;
                    toggleRepeatOptions();
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showSuccess('Set a new date and click "Reactivate Deal" to make this deal active again!');
            } catch (error) {
                showError('Error loading deal: ' + error.message);
            }
        }

        async function deleteDeal(id, name) {
            if (!confirm(`Delete deal "${name}"?`)) return;
            
            try {
                const { error } = await supabaseClient.from('deals').delete().eq('id', id);
                if (error) throw error;
                showSuccess('Deal deleted!');
                loadDeals();
            } catch (error) {
                showError('Error deleting deal: ' + error.message);
            }
        }

        async function pauseDeal(id, name) {
            if (!confirm(`Pause "${name}"? It will be hidden from the app.`)) return;
            try {
                const { error } = await supabaseClient.from('deals').update({ active: false }).eq('id', id);
                if (error) throw error;
                showSuccess('Deal paused!');
                loadDeals();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function unpauseDeal(id, name) {
            if (!confirm(`Unpause "${name}"? It will be visible in the app again.`)) return;
            try {
                const { error } = await supabaseClient.from('deals').update({ active: true }).eq('id', id);
                if (error) throw error;
                showSuccess('Deal unpaused!');
                loadDeals();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function editDeal(id) {
            try {
                const { data, error } = await supabaseClient.from('deals').select('*').eq('id', id).single();
                if (error) throw error;
                
                editingDeal = id;
                document.getElementById('dealFormTitle').textContent = 'Edit Deal';
                document.getElementById('dealSubmitBtn').textContent = 'Update Deal';
                document.getElementById('dealCancelBtn').style.display = 'inline-block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-deal-page').classList.add('active');
                
                document.getElementById('deal_name').value = data.name || '';
                document.getElementById('deal_category').value = data.category || '';
                document.getElementById('deal_description').value = data.description || '';
                document.getElementById('deal_phone').value = data.phone || '';
                document.getElementById('deal_venue_link').value = data.venue_id || '';
                document.getElementById('deal_date').value = data.deal_date || '';
                document.getElementById('deal_start_time').value = data.start_time || '12:00';
                document.getElementById('deal_end_time').value = data.end_time || '12:00';
                document.getElementById('deal_price').value = data.price || '';
                document.getElementById('deal_views').value = data.views || 0;
                
                const dealRegisteredDate = data.registered_date || new Date().toISOString().split('T')[0];
                document.getElementById('deal_registered_date').value = dealRegisteredDate;
                
                uploadedDealImage = data.image_url || null;
                renderDealImagePreview();
                
                if (data.is_recurring) {
                    document.getElementById('deal_repeat').checked = true;
                    toggleRepeatOptions();
                    
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    
                    if (data.recurring_weeks) {
                        document.getElementById('repeat_weeks').value = data.recurring_weeks;
                    }
                } else {
                    document.getElementById('deal_repeat').checked = false;
                    toggleRepeatOptions();
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                showError('Error loading deal: ' + error.message);
            }
        }

        async function loadVenuesForDealDropdown() {
            try {
                const { data, error } = await supabaseClient.from('venues').select('id, name, location_short').order('name', { ascending: true });
                if (error) throw error;
                
                const dropdown = document.getElementById('deal_venue_link');
                dropdown.innerHTML = '<option value="">Select venue...</option>';
                
                data.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue.id;
                    option.textContent = venue.name;
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading venues for dropdown:', error);
            }
        }

        // ===== EVENTS JAVASCRIPT =====
        let editingEvent = null;
        let uploadedEventImage = null;
        let allEvents = [];

        setTimeout(() => {
            const eventImageInput = document.getElementById('eventImageInput');
            if (eventImageInput) {
                eventImageInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (!file.type.startsWith('image/')) {
                        showError('Please select an image file');
                        return;
                    }
                    await uploadEventImage(file);
                });
            }
        }, 1000);

        async function uploadEventImage(file) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `event-${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const { data, error } = await supabaseClient.storage.from('venue-images').upload(fileName, file);
                if (error) throw error;
                const { data: { publicUrl } } = supabaseClient.storage.from('venue-images').getPublicUrl(fileName);
                uploadedEventImage = publicUrl;
                renderEventImagePreview();
                showSuccess('Image uploaded!');
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        function renderEventImagePreview() {
            const container = document.getElementById('eventImagePreview');
            if (!container) return;
            if (!uploadedEventImage) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `<div class="image-preview-item main-image"><img src="${uploadedEventImage}" alt="Event image"><div class="main-badge">MAIN</div><button type="button" class="remove-image" onclick="removeEventImage()">√ó</button></div>`;
        }

        function removeEventImage() {
            uploadedEventImage = null;
            renderEventImagePreview();
            const input = document.getElementById('eventImageInput');
            if (input) input.value = '';
        }

        function toggleEventRepeatOptions() {
            const checkbox = document.getElementById('event_repeat');
            const repeatOptions = document.getElementById('eventRepeatOptions');
            if (checkbox && repeatOptions) {
                if (checkbox.checked) {
                    repeatOptions.classList.remove('hidden');
                } else {
                    repeatOptions.classList.add('hidden');
                }
            }
        }

        function cancelEventEdit() {
            editingEvent = null;
            const form = document.getElementById('eventForm');
            if (form) form.reset();
            const title = document.getElementById('eventFormTitle');
            if (title) title.textContent = 'Add New Event';
            const submitBtn = document.getElementById('eventSubmitBtn');
            if (submitBtn) submitBtn.textContent = 'Add Event';
            const cancelBtn = document.getElementById('eventCancelBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';
            uploadedEventImage = null;
            renderEventImagePreview();
        }

        setTimeout(() => {
            const eventForm = document.getElementById('eventForm');
            if (eventForm) {
                eventForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const repeatDaysCheckboxes = document.querySelectorAll('input[name="event_repeat_days"]:checked');
                    const repeatDays = Array.from(repeatDaysCheckboxes).map(cb => cb.value);
                    const repeatWeeks = parseInt(document.getElementById('event_repeat_weeks').value) || 0;
                    const eventDate = document.getElementById('event_date').value;
                    const isEventRepeat = document.getElementById('event_repeat').checked;
                    
                    // Calculate end_date based on repeat settings
                    let calculatedEventEndDate;
                    if (isEventRepeat && repeatWeeks > 0) {
                        // Recurring: end_date = event_date + (recurring_weeks * 7 days)
                        const startDate = new Date(eventDate);
                        calculatedEventEndDate = new Date(startDate);
                        calculatedEventEndDate.setDate(calculatedEventEndDate.getDate() + (repeatWeeks * 7));
                        calculatedEventEndDate = calculatedEventEndDate.toISOString().split('T')[0];
                    } else {
                        // Non-recurring: end_date = same as event_date
                        calculatedEventEndDate = eventDate;
                    }

                    const eventData = {
                        name: document.getElementById('event_name').value,
                        category: document.getElementById('event_category').value,
                        description: document.getElementById('event_description').value,
                        phone: document.getElementById('event_phone').value,
                        website: document.getElementById('event_website').value || null,
                        event_date: eventDate,
                        end_date: calculatedEventEndDate,
                        start_time: document.getElementById('event_start_time').value || null,
                        end_time: document.getElementById('event_end_time').value || null,
                        is_recurring: isEventRepeat,
                        recurring_day: (isEventRepeat && repeatDays.length > 0) ? repeatDays.join(',') : null,
                        recurring_weeks: (isEventRepeat && repeatWeeks > 0) ? repeatWeeks : null,
                        price: document.getElementById('event_price').value,
                        image_url: uploadedEventImage,
                        views: parseInt(document.getElementById('event_views').value) || 0,
                        registered_date: editingEvent ? (document.getElementById('event_registered_date').value || null) : (document.getElementById('event_registered_date').value || new Date().toISOString().split('T')[0]),
                        active: true
                    };
                    try {
                        if (editingEvent) {
                            const { error } = await supabaseClient.from('events').update(eventData).eq('id', editingEvent);
                            if (error) throw error;
                            showSuccess('Event updated successfully!');
                        } else {
                            const { error } = await supabaseClient.from('events').insert([eventData]);
                            if (error) throw error;
                            showSuccess('Event created successfully!');
                        }
                        cancelEventEdit();
                        loadEvents();
                        switchPage('all-events');
                    } catch (error) {
                        showError('Error: ' + error.message);
                    }
                });
            }
        }, 1000);

        async function loadEvents() {
            const listDiv = document.getElementById('eventsList');
            if (!listDiv) return;
            listDiv.innerHTML = '<div class="loading">Loading events...</div>';
            try {
                const { data, error } = await supabaseClient.from('events').select('*, venues!events_venue_id_fkey(name, location_short)').order('event_date', { ascending: false });
                if (error) throw error;
                allEvents = data;
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No events yet!</p>';
                    return;
                }
                renderEvents(data);
            } catch (error) {
                showError('Error loading events: ' + error.message);
                listDiv.innerHTML = '<p style="text-align:center;color:#e74c3c;">Error loading events.</p>';
            }
        }

        function renderEvents(events) {
            const listDiv = document.getElementById('eventsList');
            if (!listDiv) return;
            if (events.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No events match your filters.</p>';
                return;
            }
            listDiv.innerHTML = events.map(event => `
                <div class="venue-item">
                    <div class="status-indicator ${event.active ? 'status-active' : 'status-inactive'}" title="${event.active ? 'Active' : 'Inactive'}"></div>
                    <div class="venue-info">
                        <h3>${event.name}</h3>
                        <p><strong>Category:</strong> ${event.category || 'N/A'}</p>
                        ${event.venues?.name ? `<p><strong>Venue:</strong> ${event.venues.name} - ${event.venues.location_short || ''}</p>` : ''}
                        ${event.website ? `<p><strong>Website:</strong> <a href="${event.website}" target="_blank">${event.website}</a></p>` : ''}
                        <p><strong>Date:</strong> ${event.event_date} ${event.start_time ? `(${event.start_time.slice(0,5)} - ${event.end_time.slice(0,5)})` : ''}</p>
                        ${event.end_date ? `<p><strong>End Date:</strong> ${event.end_date}</p>` : ''}
                        ${event.is_recurring ? `<p><strong>Recurring:</strong> ${event.recurring_day} (${event.recurring_weeks} weeks)</p>` : ''}
                        <p><strong>Price:</strong> ${event.price || 'Free'} | <strong>Status:</strong> ${event.active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                        ${event.image_url ? '<p><strong>Image:</strong> üì∏</p>' : ''}
                    </div>
                    <div class="venue-actions">
                        ${!event.active ? `<button class="reactivate" onclick="reactivateEvent(${event.id})">üîÑ Reactivate</button>` : ''}
                        ${event.active ? 
                            `<button class="reactivate" onclick="pauseEvent(${event.id}, '${event.name.replace(/'/g, "\\'")}')">‚è∏Ô∏è Pause</button>` : 
                            `<button class="reactivate" onclick="unpauseEvent(${event.id}, '${event.name.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è Unpause</button>`
                        }
                        <button class="edit" onclick="editEvent(${event.id})">Edit</button>
                        <button class="delete" onclick="deleteEvent(${event.id}, '${event.name.replace(/'/g, "\\'")}')" >Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterEvents() {
            const searchTerm = document.getElementById('eventSearch')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('eventCategoryFilter')?.value || '';
            const statusFilter = document.getElementById('eventStatusFilter')?.value || 'all';
            let filtered = allEvents;
            if (searchTerm) filtered = filtered.filter(e => e.name.toLowerCase().includes(searchTerm));
            if (categoryFilter) filtered = filtered.filter(e => e.category === categoryFilter);
            if (statusFilter === 'active') filtered = filtered.filter(e => e.active === true);
            else if (statusFilter === 'inactive') filtered = filtered.filter(e => e.active === false);
            const resultsDiv = document.getElementById('eventFilterResults');
            if (resultsDiv) {
                if (searchTerm || categoryFilter || statusFilter !== 'all') {
                    resultsDiv.style.display = 'block';
                    resultsDiv.textContent = `Showing ${filtered.length} of ${allEvents.length} events`;
                } else {
                    resultsDiv.style.display = 'none';
                }
            }
            renderEvents(filtered);
        }

        async function editEvent(id) {
            try {
                const { data, error } = await supabaseClient.from('events').select('*').eq('id', id).single();
                if (error) throw error;
                editingEvent = id;
                document.getElementById('eventFormTitle').textContent = 'Edit Event';
                document.getElementById('eventSubmitBtn').textContent = 'Update Event';
                document.getElementById('eventCancelBtn').style.display = 'inline-block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-event-page').classList.add('active');
                
                document.getElementById('event_name').value = data.name || '';
                document.getElementById('event_category').value = data.category || '';
                document.getElementById('event_description').value = data.description || '';
                document.getElementById('event_phone').value = data.phone || '';
                document.getElementById('event_website').value = data.website || '';
                document.getElementById('event_date').value = data.event_date || '';
                document.getElementById('event_start_time').value = data.start_time || '20:00';
                document.getElementById('event_end_time').value = data.end_time || '23:00';
                document.getElementById('event_price').value = data.price || '';
                document.getElementById('event_views').value = data.views || 0;
                document.getElementById('event_registered_date').value = data.registered_date || '';
                uploadedEventImage = data.image_url || null;
                renderEventImagePreview();
                if (data.is_recurring) {
                    document.getElementById('event_repeat').checked = true;
                    toggleEventRepeatOptions();
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="event_repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    if (data.recurring_weeks) document.getElementById('event_repeat_weeks').value = data.recurring_weeks;
                } else {
                    document.getElementById('event_repeat').checked = false;
                    toggleEventRepeatOptions();
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                showError('Error loading event: ' + error.message);
            }
        }

        async function reactivateEvent(id) {
            try {
                const { data, error } = await supabaseClient.from('events').select('*').eq('id', id).single();
                if (error) throw error;
                editingEvent = id;
                document.getElementById('eventFormTitle').textContent = 'Reactivate Event - Set New Date';
                document.getElementById('eventSubmitBtn').textContent = 'Reactivate Event';
                document.getElementById('eventCancelBtn').style.display = 'inline-block';
                
                const pages = document.querySelectorAll('.content-page');
                pages.forEach(page => page.classList.remove('active'));
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                document.getElementById('add-event-page').classList.add('active');
                
                document.getElementById('event_name').value = data.name || '';
                document.getElementById('event_category').value = data.category || '';
                document.getElementById('event_description').value = data.description || '';
                document.getElementById('event_phone').value = data.phone || '';
                document.getElementById('event_website').value = data.website || '';
                document.getElementById('event_date').value = '';
                document.getElementById('event_start_time').value = data.start_time || '20:00';
                document.getElementById('event_end_time').value = data.end_time || '23:00';
                document.getElementById('event_price').value = data.price || '';
                document.getElementById('event_views').value = 0;
                document.getElementById('event_registered_date').value = '';
                uploadedEventImage = data.image_url || null;
                renderEventImagePreview();
                if (data.is_recurring) {
                    document.getElementById('event_repeat').checked = true;
                    toggleEventRepeatOptions();
                    if (data.recurring_day) {
                        const days = data.recurring_day.split(',');
                        days.forEach(day => {
                            const dayCheckbox = document.querySelector(`input[name="event_repeat_days"][value="${day.trim()}"]`);
                            if (dayCheckbox) dayCheckbox.checked = true;
                        });
                    }
                    if (data.recurring_weeks) document.getElementById('event_repeat_weeks').value = data.recurring_weeks;
                } else {
                    document.getElementById('event_repeat').checked = false;
                    toggleEventRepeatOptions();
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showSuccess('Set a new date and click "Reactivate Event"!');
            } catch (error) {
                showError('Error loading event: ' + error.message);
            }
        }

        async function deleteEvent(id, name) {
            if (!confirm(`Delete event "${name}"?`)) return;
            try {
                const { error } = await supabaseClient.from('events').delete().eq('id', id);
                if (error) throw error;
                showSuccess('Event deleted!');
                loadEvents();
            } catch (error) {
                showError('Error deleting event: ' + error.message);
            }
        }

        async function pauseEvent(id, name) {
            if (!confirm(`Pause "${name}"? It will be hidden from the app.`)) return;
            try {
                const { error } = await supabaseClient.from('events').update({ active: false }).eq('id', id);
                if (error) throw error;
                showSuccess('Event paused!');
                loadEvents();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function unpauseEvent(id, name) {
            if (!confirm(`Unpause "${name}"? It will be visible in the app again.`)) return;
            try {
                const { error } = await supabaseClient.from('events').update({ active: true }).eq('id', id);
                if (error) throw error;
                showSuccess('Event unpaused!');
                loadEvents();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // ===== VISITORS & CUSTOMERS JAVASCRIPT =====
        async function loadVisitors() {
            const listDiv = document.getElementById('visitorsList');
            listDiv.innerHTML = '<div class="loading">Loading visitors...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('id, email, name, created_at, user_type')
                    .eq('user_type', 'visitor')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allVisitors = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No visitors yet!</p>';
                    return;
                }
                
                renderVisitors(data);
            } catch (error) {
                showError('Error loading visitors: ' + error.message);
            }
        }

        function renderVisitors(visitors) {
            const listDiv = document.getElementById('visitorsList');
            
            if (visitors.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No visitors match your search.</p>';
                return;
            }
            
            listDiv.innerHTML = visitors.map(v => `
                <div class="venue-item">
                    <div class="venue-info">
                        <h3>${v.name || 'No name'}</h3>
                        <p><strong>Email:</strong> ${v.email}</p>
                        <p><strong>Registered:</strong> ${new Date(v.created_at).toLocaleDateString('sv-SE')}</p>
                        <p><strong>Type:</strong> üë• Visitor</p>
                    </div>
                    <div class="venue-actions">
                        <button class="edit" onclick="editVisitor('${v.id}', '${v.name || ''}')">Edit</button>
                        <button class="delete" onclick="deleteVisitor('${v.id}', '${(v.name || 'this visitor').replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterVisitors() {
            const searchTerm = document.getElementById('visitorSearch').value.toLowerCase();
            
            let filtered = allVisitors;
            
            if (searchTerm) {
                filtered = filtered.filter(v => 
                    (v.name && v.name.toLowerCase().includes(searchTerm)) || 
                    (v.email && v.email.toLowerCase().includes(searchTerm))
                );
            }
            
            const resultsDiv = document.getElementById('visitorFilterResults');
            if (searchTerm) {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allVisitors.length} visitors`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderVisitors(filtered);
        }

        async function loadCustomers() {
            const listDiv = document.getElementById('customersList');
            listDiv.innerHTML = '<div class="loading">Loading customers...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select(`
                        id,
                        email,
                        name,
                        user_type,
                        venue_id,
                        is_active,
                        created_at,
                        venues!profiles_venue_id_fkey(id, name, credits, subscription_status, subscription_expires_at)
                    `)
                    .eq('user_type', 'venue')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allCustomers = data;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center;color:#999;">No venue customers yet!</p>';
                    return;
                }
                
                renderCustomers(data);
            } catch (error) {
                showError('Error loading customers: ' + error.message);
            }
        }

        function renderCustomers(customers) {
            const listDiv = document.getElementById('customersList');
            
            if (customers.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;">No customers match your filters.</p>';
                return;
            }
            
            listDiv.innerHTML = customers.map(c => `
                <div class="venue-item">
                    <div class="status-indicator ${c.is_active ? 'status-active' : 'status-inactive'}" title="${c.is_active ? 'Active' : 'Inactive'}"></div>
                    <div class="venue-info">
                        <h3>${c.venues?.name || 'No venue linked'}</h3>
                        <p><strong>Email:</strong> ${c.email}</p>
                        <p><strong>Credits:</strong> ${c.venues?.credits || 0}</p>
                        <p><strong>Subscription:</strong> ${c.venues?.subscription_status || 'inactive'}</p>
                        ${c.venues?.subscription_expires_at ? `<p><strong>Expires:</strong> ${new Date(c.venues.subscription_expires_at).toLocaleDateString('sv-SE')}</p>` : ''}
                        <p><strong>Registered:</strong> ${new Date(c.created_at).toLocaleDateString('sv-SE')}</p>
                        <p><strong>Status:</strong> ${c.is_active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                    </div>
                    <div class="venue-actions">
                        ${c.is_active ? 
                            `<button class="reactivate" onclick="deactivateCustomer('${c.id}', '${c.venues?.name || 'this customer'}')">‚è∏Ô∏è Deactivate</button>` : 
                            `<button class="reactivate" onclick="activateCustomer('${c.id}', '${c.venues?.name || 'this customer'}')">‚ñ∂Ô∏è Activate</button>`
                        }
                        <button class="edit" onclick="editCustomer('${c.id}', ${c.venues?.credits || 0}, ${c.venue_id})">Edit Credits</button>
                        <button class="delete" onclick="deleteCustomer('${c.id}', '${c.venues?.name || 'this customer'}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const statusFilter = document.getElementById('customerStatusFilter').value;
            
            let filtered = allCustomers;
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                    (c.venues?.name && c.venues.name.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(c => c.is_active === true);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(c => c.is_active === false);
            }
            
            const resultsDiv = document.getElementById('customerFilterResults');
            if (searchTerm || statusFilter !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allCustomers.length} customers`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderCustomers(filtered);
        }

        async function activateCustomer(profileId, venueName) {
            if (!confirm(`Activate "${venueName}"?`)) return;
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ is_active: true })
                    .eq('id', profileId);
                
                if (error) throw error;
                showSuccess('Customer activated!');
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function deactivateCustomer(profileId, venueName) {
            if (!confirm(`Deactivate "${venueName}"? They won't be able to log in.`)) return;
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ is_active: false })
                    .eq('id', profileId);
                
                if (error) throw error;
                showSuccess('Customer deactivated!');
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // ===== MODAL FUNCTIONS - NYA FUNKTIONER! =====
        
        // VISITOR MODAL FUNCTIONS
       function editVisitor(visitorId, currentName) {
    currentEditingVisitorId = visitorId;
    document.getElementById('modal_visitor_name').value = currentName;
    document.getElementById('editVisitorModal').classList.add('active');
}
        
        function closeVisitorModal() {
            document.getElementById('editVisitorModal').classList.remove('active');
            currentEditingVisitorId = null;
        }
        
        async function saveVisitor() {
    if (!currentEditingVisitorId) return;
    
    const newName = document.getElementById('modal_visitor_name').value;
    
    if (!newName) {
        showError('Name is required!');
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('profiles')
            .update({ 
                name: newName
            })
            .eq('id', currentEditingVisitorId);
        
        if (error) throw error;
        showSuccess('Visitor updated!');
        closeVisitorModal();
        loadVisitors();
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

        // CUSTOMER MODAL FUNCTIONS
        function editCustomer(customerId, currentCredits, venueId) {
            currentEditingCustomerId = customerId;
            document.getElementById('modal_customer_credits').value = currentCredits;
            document.getElementById('modal_customer_credits').dataset.venueId = venueId;
            document.getElementById('editCustomerModal').classList.add('active');
        }
        
        function closeCustomerModal() {
            document.getElementById('editCustomerModal').classList.remove('active');
            currentEditingCustomerId = null;
        }
        
        async function saveCustomer() {
            if (!currentEditingCustomerId) return;
            
            const newCredits = parseInt(document.getElementById('modal_customer_credits').value);
            const venueId = parseInt(document.getElementById('modal_customer_credits').dataset.venueId);
            
            if (isNaN(newCredits)) {
                showError('Please enter a valid number for credits!');
                return;
            }
            
            if (!venueId) {
                showError('No venue linked!');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('venues')
                    .update({ credits: newCredits })
                    .eq('id', venueId);
                
                if (error) throw error;
                showSuccess('Credits updated!');
                closeCustomerModal();
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function deleteVisitor(visitorId, visitorName) {
            if (!confirm(`Delete visitor "${visitorName}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .delete()
                    .eq('id', visitorId);
                
                if (error) throw error;
                showSuccess('Visitor deleted!');
                loadVisitors();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function deleteCustomer(customerId, venueName) {
            if (!confirm(`Delete "${venueName}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .delete()
                    .eq('id', customerId);
                
                if (error) throw error;
                showSuccess('Customer deleted!');
                loadCustomers();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // ===== DASHBOARD FUNCTIONS =====
        let salesChart = null;
        let packagesChart = null;

        function switchDashTab(tabName) {
            // Hide all content
            document.querySelectorAll('.dash-content').forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected content
            const content = document.getElementById('dashboard-' + tabName);
            if (content) {
                content.classList.add('active');
                content.style.display = 'block';
            }
            
            // Activate tab
            const tab = document.getElementById('tab-' + tabName);
            if (tab) tab.classList.add('active');

            // Load data for the selected tab
            if (tabName === 'payments') {
                loadPaymentsTabData();
            } else if (tabName === 'reviews') {
                loadReviewsTabData();
            }
        }

        function updateDashboardPeriod() {
            const days = parseInt(document.getElementById('dashboardPeriod').value);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            
            const formatDate = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            document.getElementById('dashboardDateRange').textContent = `${formatDate(startDate)} to ${formatDate(endDate)}`;
            
            loadDashboardData();
        }

        async function loadDashboardData() {
            try {
                // Load visitors count
                const { data: visitors, error: visitorsError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('user_type', 'visitor');
                
                if (!visitorsError && visitors) {
                    document.getElementById('stat-visitors').textContent = visitors.length.toLocaleString();
                    document.getElementById('stat-visitors-percent').textContent = '42%';
                    document.getElementById('stat-visitors-bar').style.width = '42%';
                }

                // Load total venue views (impressions)
                const { data: venues, error: venuesError } = await supabaseClient
                    .from('venues')
                    .select('views');
                
                if (!venuesError && venues) {
                    const totalViews = venues.reduce((sum, v) => sum + (v.views || 0), 0);
                    document.getElementById('stat-impressions').textContent = totalViews.toLocaleString();
                    document.getElementById('stat-impressions-percent').textContent = '33%';
                    document.getElementById('stat-impressions-bar').style.width = '33%';
                }

                // Load total clicks (deal + event views)
                const { data: deals } = await supabaseClient.from('deals').select('views');
                const { data: events } = await supabaseClient.from('events').select('views');
                
                let totalClicks = 0;
                if (deals) totalClicks += deals.reduce((sum, d) => sum + (d.views || 0), 0);
                if (events) totalClicks += events.reduce((sum, e) => sum + (e.views || 0), 0);
                
                document.getElementById('stat-clicks').textContent = totalClicks.toLocaleString();
                document.getElementById('stat-clicks-percent').textContent = '25%';
                document.getElementById('stat-clicks-bar').style.width = '25%';

                // Pageviews (total deal + event + venue views)
                const { data: allVenues } = await supabaseClient.from('venues').select('views, active');
                const { data: allDeals } = await supabaseClient.from('deals').select('views, active');
                const { data: allEvents } = await supabaseClient.from('events').select('views, active');
                
                let totalPageviews = 0;
                if (allVenues) totalPageviews += allVenues.reduce((sum, v) => sum + (v.views || 0), 0);
                if (allDeals) totalPageviews += allDeals.reduce((sum, d) => sum + (d.views || 0), 0);
                if (allEvents) totalPageviews += allEvents.reduce((sum, e) => sum + (e.views || 0), 0);
                
                document.getElementById('stat-pageviews').textContent = totalPageviews.toLocaleString();
                document.getElementById('stat-revenue-percent').textContent = '65%';
                document.getElementById('stat-revenue-bar').style.width = '65%';

                // Second row stats - Venues, Visitors, Active Deals, Active Events
                if (allVenues) {
                    const activeVenues = allVenues.filter(v => v.active !== false).length;
                    document.getElementById('stat-venues-analytics').textContent = activeVenues.toLocaleString();
                    document.getElementById('stat-venues-analytics-percent').textContent = '100%';
                    document.getElementById('stat-venues-analytics-bar').style.width = '100%';
                }

                // Visitors count (same as first row but for second row)
                document.getElementById('stat-visitors-analytics').textContent = visitors ? visitors.length.toLocaleString() : '0';
                document.getElementById('stat-visitors-analytics-percent').textContent = '42%';
                document.getElementById('stat-visitors-analytics-bar').style.width = '42%';

                // Active Deals
                if (allDeals) {
                    const activeDeals = allDeals.filter(d => d.active === true).length;
                    document.getElementById('stat-deals-analytics').textContent = activeDeals.toLocaleString();
                    document.getElementById('stat-deals-analytics-percent').textContent = '75%';
                    document.getElementById('stat-deals-analytics-bar').style.width = '75%';
                }

                // Active Events
                if (allEvents) {
                    const activeEvents = allEvents.filter(e => e.active === true).length;
                    document.getElementById('stat-events-analytics').textContent = activeEvents.toLocaleString();
                    document.getElementById('stat-events-analytics-percent').textContent = '60%';
                    document.getElementById('stat-events-analytics-bar').style.width = '60%';
                }

                // Initialize charts
                initCharts();
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function initCharts() {
            // Sales Line Chart
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                if (salesChart) salesChart.destroy();
                
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
                        datasets: [
                            {
                                label: 'Gold',
                                data: [20, 45, 60, 80, 75, 90, 50, 60, 145],
                                borderColor: '#7c3aed',
                                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                                tension: 0.4,
                                fill: false,
                                pointRadius: 4,
                                pointBackgroundColor: '#7c3aed'
                            },
                            {
                                label: 'Silver',
                                data: [10, 35, 70, 65, 85, 55, 40, 45, 110],
                                borderColor: '#a78bfa',
                                backgroundColor: 'rgba(167, 139, 250, 0.1)',
                                tension: 0.4,
                                fill: false,
                                pointRadius: 4,
                                pointBackgroundColor: '#a78bfa'
                            },
                            {
                                label: 'Bronze',
                                data: [5, 25, 40, 35, 50, 30, 25, 30, 50],
                                borderColor: '#06b6d4',
                                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                                tension: 0.4,
                                fill: false,
                                borderDash: [5, 5],
                                pointRadius: 4,
                                pointBackgroundColor: '#06b6d4'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 160,
                                grid: { color: '#f0f0f0' },
                                ticks: { stepSize: 20 }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // Packages Donut Chart
            const packagesCtx = document.getElementById('packagesChart');
            if (packagesCtx) {
                if (packagesChart) packagesChart.destroy();
                
                packagesChart = new Chart(packagesCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Gold', 'Silver', 'Bronze'],
                        datasets: [{
                            data: [45, 30, 25],
                            backgroundColor: ['#7c3aed', '#a78bfa', '#06b6d4'],
                            borderWidth: 0,
                            cutout: '55%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboardPeriod();
        });

        // ===== PAYMENTS TAB FUNCTIONS =====
        let currentPaymentMonth = 1;
        let allPaymentsData = [];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const packagePrices = { 'Bronze': 99, 'Silver': 199, 'Gold': 499 };

        function switchPaymentMonth(month) {
            currentPaymentMonth = month;
            
            // Update tab styles
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.style.background = '#f3f4f6';
                tab.style.color = '#666';
            });
            const activeTab = document.getElementById('month-' + month);
            if (activeTab) {
                activeTab.style.background = '#7c3aed';
                activeTab.style.color = 'white';
            }
            
            // Update month name
            document.getElementById('current-month-name').textContent = monthNames[month - 1];
            
            // Load payments for this month
            loadPaymentsForMonth(month);
        }

        async function loadPaymentsTabData() {
            try {
                const { data: venues, error } = await supabaseClient
                    .from('venues')
                    .select('id, name, package, payment_date, active')
                    .eq('active', true);
                
                if (error) throw error;
                
                // Konvertera venues till payments format
                allPaymentsData = (venues || []).map(v => {
                    const pkg = v.package || 'Gold';
                    const paymentMonth = v.payment_date ? new Date(v.payment_date).getMonth() + 1 : new Date().getMonth() + 1;
                    
                    return {
                        id: v.id,
                        venue_name: v.name,
                        package: pkg,
                        amount: packagePrices[pkg] || 499,
                        payment_month: paymentMonth,
                        paid: !!v.payment_date,
                        paid_date: v.payment_date
                    };
                });
                
                const currentMonth = new Date().getMonth() + 1;
                switchPaymentMonth(currentMonth);
            } catch (error) {
                console.error('Error loading payments:', error);
                allPaymentsData = [];
                switchPaymentMonth(new Date().getMonth() + 1);
            }
        }

        function loadPaymentsForMonth(month) {
            const monthPayments = allPaymentsData.filter(p => p.payment_month === month);
            
            // Calculate totals
            const total = monthPayments.reduce((sum, p) => sum + p.amount, 0);
            const paid = monthPayments.filter(p => p.paid).reduce((sum, p) => sum + p.amount, 0);
            const unpaid = monthPayments.filter(p => !p.paid).reduce((sum, p) => sum + p.amount, 0);
            
            document.getElementById('payment-total').textContent = '‚Ç¨' + total.toLocaleString();
            document.getElementById('payment-paid').textContent = '‚Ç¨' + paid.toLocaleString();
            document.getElementById('payment-unpaid').textContent = '‚Ç¨' + unpaid.toLocaleString();
            
            // Render payments list
            renderPayments(monthPayments);
        }

        function renderPayments(payments) {
            const listDiv = document.getElementById('paymentsList');
            
            if (!payments || payments.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p style="font-size: 16px; margin-bottom: 10px;">No payments for this month</p>
                        <p style="font-size: 13px;">Payments will appear here when venues have active subscriptions.</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = payments.map(payment => {
                const statusColor = payment.paid ? '#22c55e' : '#ef4444';
                const statusBg = payment.paid ? '#dcfce7' : '#fee2e2';
                const statusText = payment.paid ? 'Paid' : 'Unpaid';
                const packageColor = payment.package === 'Gold' ? '#f59e0b' : payment.package === 'Silver' ? '#9ca3af' : '#cd7f32';
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: #7c3aed; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
                                ${payment.venue_name.charAt(0)}
                            </div>
                            <div>
                                <strong style="color: #23282d; font-size: 15px;">${payment.venue_name}</strong>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 4px;">
                                    <span style="background: ${packageColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500;">${payment.package}</span>
                                    ${payment.paid ? `<span style="color: #999; font-size: 12px;">Paid on ${payment.paid_date}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 18px; font-weight: 600; color: #23282d;">‚Ç¨${payment.amount}</span>
                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500;">${statusText}</span>
                            ${!payment.paid ? 
                                `<button onclick="markAsPaid(${payment.id})" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500;">‚úì Mark Paid</button>` :
                                `<button onclick="markAsUnpaid(${payment.id})" style="background: #f3f4f6; color: #666; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500;">Undo</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterPayments() {
            const filter = document.getElementById('paymentStatusFilter').value;
            let monthPayments = allPaymentsData.filter(p => p.payment_month === currentPaymentMonth);
            
            if (filter === 'paid') {
                monthPayments = monthPayments.filter(p => p.paid);
            } else if (filter === 'unpaid') {
                monthPayments = monthPayments.filter(p => !p.paid);
            }
            
            renderPayments(monthPayments);
        }

        async function markAsPaid(id) {
            const payment = allPaymentsData.find(p => p.id === id);
            if (payment) {
                const today = new Date().toISOString().split('T')[0];
                
                try {
                    const { error } = await supabaseClient
                        .from('venues')
                        .update({ payment_date: today })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    payment.paid = true;
                    payment.paid_date = today;
                    showSuccess(`${payment.venue_name} marked as paid!`);
                    loadPaymentsForMonth(currentPaymentMonth);
                } catch (error) {
                    showError('Failed to update payment: ' + error.message);
                }
            }
        }

        async function markAsUnpaid(id) {
            const payment = allPaymentsData.find(p => p.id === id);
            if (payment) {
                try {
                    const { error } = await supabaseClient
                        .from('venues')
                        .update({ payment_date: null })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    payment.paid = false;
                    payment.paid_date = null;
                    showSuccess(`${payment.venue_name} marked as unpaid`);
                    loadPaymentsForMonth(currentPaymentMonth);
                } catch (error) {
                    showError('Failed to update payment: ' + error.message);
                }
            }
        }

        // ===== REVIEWS TAB FUNCTIONS =====
        let allReviewsData = [];

        async function loadReviewsTabData() {
            try {
                // Load all reviews
                const { data: reviews, error } = await supabaseClient
                    .from('reviews')
                    .select(`
                        *,
                        venues!reviews_venue_id_fkey(name),
                        profiles!reviews_user_id_fkey(name, email)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.log('Reviews table may not exist yet:', error.message);
                    // Show placeholder if no reviews table
                    document.getElementById('reviewsList').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p style="font-size: 16px; margin-bottom: 10px;">No reviews yet</p>
                            <p style="font-size: 13px;">Reviews will appear here when users submit them in the app.</p>
                        </div>
                    `;
                    return;
                }

                allReviewsData = reviews || [];
                
                // Update stats
                const total = allReviewsData.length;
                const published = allReviewsData.filter(r => r.status === 'published' || r.status === undefined).length;
                const pending = allReviewsData.filter(r => r.status === 'pending').length;
                const paused = allReviewsData.filter(r => r.status === 'paused').length;
                
                document.getElementById('stat-total-reviews').textContent = total.toLocaleString();
                document.getElementById('stat-pending-reviews').textContent = pending.toLocaleString();
                document.getElementById('stat-published-reviews').textContent = published.toLocaleString();
                
                // Calculate average rating
                if (total > 0) {
                    const avgRating = allReviewsData.reduce((sum, r) => sum + (r.rating || 0), 0) / total;
                    document.getElementById('stat-avg-rating').textContent = avgRating.toFixed(1);
                    
                    // Update stars display
                    const fullStars = Math.floor(avgRating);
                    const hasHalf = avgRating % 1 >= 0.5;
                    let starsHtml = '‚òÖ'.repeat(fullStars);
                    if (hasHalf && fullStars < 5) starsHtml += '‚òÜ';
                    starsHtml += '‚òÜ'.repeat(5 - fullStars - (hasHalf ? 1 : 0));
                    document.getElementById('stat-avg-rating-stars').textContent = starsHtml;
                    document.getElementById('stat-avg-rating-bar').style.width = (avgRating / 5 * 100) + '%';
                }

                // Update percentages
                if (total > 0) {
                    document.getElementById('stat-pending-reviews-percent').textContent = Math.round(pending / total * 100) + '%';
                    document.getElementById('stat-pending-reviews-bar').style.width = (pending / total * 100) + '%';
                    document.getElementById('stat-published-reviews-percent').textContent = Math.round(published / total * 100) + '%';
                    document.getElementById('stat-published-reviews-bar').style.width = (published / total * 100) + '%';
                }

                // Render reviews list
                renderReviews(allReviewsData);
            } catch (error) {
                console.error('Reviews tab load error:', error);
                document.getElementById('reviewsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p>No reviews yet</p>
                    </div>
                `;
            }
        }

        function renderReviews(reviews) {
            const listDiv = document.getElementById('reviewsList');
            
            if (!reviews || reviews.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p style="font-size: 16px; margin-bottom: 10px;">No reviews found</p>
                        <p style="font-size: 13px;">Reviews will appear here when users submit them.</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = reviews.map(review => {
                const status = review.status || 'published';
                const statusColor = status === 'published' ? '#22c55e' : status === 'pending' ? '#f59e0b' : '#ef4444';
                const statusBg = status === 'published' ? '#dcfce7' : status === 'pending' ? '#fef3c7' : '#fee2e2';
                const stars = '‚òÖ'.repeat(review.rating || 0) + '‚òÜ'.repeat(5 - (review.rating || 0));
                const date = new Date(review.created_at).toLocaleDateString('sv-SE');
                
                return `
                    <div style="display: flex; gap: 15px; padding: 20px; border-bottom: 1px solid #f0f0f0; align-items: flex-start;">
                        <div style="width: 50px; height: 50px; background: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; flex-shrink: 0;">
                            ${(review.profiles?.name || review.profiles?.email || 'U').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: #23282d;">${review.profiles?.name || review.profiles?.email || 'Anonymous'}</strong>
                                    <span style="color: #999; font-size: 13px; margin-left: 10px;">${date}</span>
                                </div>
                                <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                            </div>
                            <div style="color: #f59e0b; font-size: 14px; margin-bottom: 6px;">${stars}</div>
                            <p style="color: #23282d; font-size: 14px; margin: 0 0 8px 0; line-height: 1.5;">${review.comment || review.text || 'No comment'}</p>
                            <p style="color: #666; font-size: 13px; margin: 0;">Venue: <strong>${review.venues?.name || 'Unknown'}</strong></p>
                            <div style="margin-top: 12px; display: flex; gap: 8px;">
                                ${status === 'published' ? 
                                    `<button onclick="pauseReview(${review.id})" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">‚è∏Ô∏è Pause</button>` :
                                    `<button onclick="publishReview(${review.id})" style="background: #22c55e; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">‚úÖ Publish</button>`
                                }
                                <button onclick="deleteReview(${review.id})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterReviews() {
            const statusFilter = document.getElementById('reviewStatusFilter').value;
            const ratingFilter = document.getElementById('reviewRatingFilter').value;
            
            let filtered = allReviewsData;
            
            if (statusFilter !== 'all') {
                if (statusFilter === 'published') {
                    filtered = filtered.filter(r => r.status === 'published' || r.status === undefined);
                } else {
                    filtered = filtered.filter(r => r.status === statusFilter);
                }
            }
            
            if (ratingFilter !== 'all') {
                filtered = filtered.filter(r => r.rating === parseInt(ratingFilter));
            }
            
            const resultsDiv = document.getElementById('reviewFilterResults');
            if (statusFilter !== 'all' || ratingFilter !== 'all') {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `Showing ${filtered.length} of ${allReviewsData.length} reviews`;
            } else {
                resultsDiv.style.display = 'none';
            }
            
            renderReviews(filtered);
        }

        async function pauseReview(id) {
            if (!confirm('Pause this review? It will be hidden from public view.')) return;
            try {
                const { error } = await supabaseClient
                    .from('reviews')
                    .update({ status: 'paused' })
                    .eq('id', id);
                
                if (error) throw error;
                showSuccess('Review paused!');
                loadReviewsTabData();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function publishReview(id) {
            try {
                const { error } = await supabaseClient
                    .from('reviews')
                    .update({ status: 'published' })
                    .eq('id', id);
                
                if (error) throw error;
                showSuccess('Review published!');
                loadReviewsTabData();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function deleteReview(id) {
            if (!confirm('Delete this review permanently?')) return;
            try {
                const { error } = await supabaseClient
                    .from('reviews')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                showSuccess('Review deleted!');
                loadReviewsTabData();
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // ===== PACKAGES FUNCTIONS =====
        async function loadPackages() {
            try {
                const { data, error } = await supabaseClient
                    .from('package_benefits')
                    .select('*');
                
                if (error) {
                    console.log('Package benefits table may not exist yet or is empty');
                    return;
                }
                
                if (data && data.length > 0) {
                    data.forEach(pkg => {
                        const textarea = document.getElementById(pkg.package_name.toLowerCase() + 'PackageBenefits');
                        if (textarea && pkg.benefits) {
                            textarea.value = pkg.benefits.join('\n');
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        async function savePackageBenefits(packageName) {
            const textarea = document.getElementById(packageName.toLowerCase() + 'PackageBenefits');
            const benefits = textarea.value.split('\n').filter(line => line.trim() !== '');
            
            try {
                // First try to update existing
                const { data: existing } = await supabaseClient
                    .from('package_benefits')
                    .select('id')
                    .eq('package_name', packageName)
                    .single();
                
                if (existing) {
                    // Update existing
                    const { error } = await supabaseClient
                        .from('package_benefits')
                        .update({ benefits: benefits })
                        .eq('package_name', packageName);
                    
                    if (error) throw error;
                } else {
                    // Insert new
                    const { error } = await supabaseClient
                        .from('package_benefits')
                        .insert([{ package_name: packageName, benefits: benefits }]);
                    
                    if (error) throw error;
                }
                
                showSuccess(packageName + ' package saved!');
            } catch (error) {
                showError('Error saving package: ' + error.message);
            }
        }

    </script>
</body>
</html>